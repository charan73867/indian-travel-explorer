<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>India Travel Explorer - Discover Incredible India</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    
    <!-- Include your CSS styles here -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary:rgb(255, 93, 53);
            --secondary: #F7931E;
            --accent: #C1292E;
            --spotify: #1DB954;
            --dark: #1A1A2E;
            --darker: #0F0F1E;
            --light: #F5F5F5;
            --white: #FFFFFF;
            --success: #00C896;
            --warning: #FFD93D;
            --gradient-primary: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            --gradient-dark: linear-gradient(135deg, #1A1A2E 0%, #0F0F1E 100%);
            --gradient-accent: linear-gradient(135deg, #C1292E 0%, #FF6B35 100%);
            --gradient-spotify: linear-gradient(135deg, #1DB954 0%, #1AA34A 100%);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Tourist Places Styles */
        .tourist-places-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .place-category-icons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        .place-category-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--white);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 80px;
            box-shadow: var(--shadow-sm);
        }
        
        .place-category-icon:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        
        .place-category-icon.active {
            background: var(--gradient-primary);
            color: var(--white);
        }
        
        .icon-emoji {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .icon-label {
            font-size: 11px;
            text-align: center;
            font-weight: 500;
        }
        
        /* Icons for different place categories */
        .hospital-marker-icon, .gas-marker-icon, .atm-marker-icon, 
        .mall-marker-icon, .bus-marker-icon, .train-marker-icon,
        .religious-marker-icon, .entertainment-marker-icon {
            background: transparent;
            width: 40px !important;
            height: 40px !important;
        }
        
        .hospital-marker, .gas-marker, .atm-marker, 
        .mall-marker, .bus-marker, .train-marker,
        .religious-marker, .entertainment-marker {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        .hospital-marker span { color: #E91E63; }
        .gas-marker span { color: #FF9800; }
        .atm-marker span { color: #4CAF50; }
        .mall-marker span { color: #9C27B0; }
        .bus-marker span { color: #03A9F4; }
        .train-marker span { color: #673AB7; }
        .religious-marker span { color: #FFEB3B; }
        .entertainment-marker span { color: #F44336; }
        
        /* Nearby category places styling */
        .nearby-categories-section {
            margin-top: 30px;
        }
        
        .categories-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .category-tab {
            padding: 8px 15px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark);
            background: var(--light);
            border-radius: 50px;
            transition: all 0.3s ease;
        }
        
        .category-tab:hover {
            background: var(--primary);
            color: var(--white);
            transform: translateY(-2px);
        }
        
        .category-tab.active {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: var(--shadow-md);
        }
        
        .category-content {
            display: none;
        }
        
        .category-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .distance-badge {
            background: var(--primary);
            color: var(--white);
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }
        .tourist-place-item {
            background: var(--white);
            margin-bottom: 12px;
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary);
        }

        .tourist-place-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.8) 100%);
        }

        .tourist-place-item:active {
            transform: translateX(4px);
        }

        .place-name {
            font-weight: 600;
            color: var(--dark);
        }

        .view-details {
            color: var(--primary);
            font-size: 14px;
            font-weight: 500;
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        .tourist-place-item:hover .view-details {
            opacity: 1;
            transform: translateX(5px);
        }

        /* Tourist Place Details */
        .tourist-place-details {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            background: var(--light);
            border-radius: 50px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--dark);
        }

        .back-button:hover {
            background: var(--dark);
            color: var(--white);
            transform: translateX(-5px);
        }

        .back-icon {
            margin-right: 8px;
            font-size: 18px;
        }

        .place-header {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .place-rating {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 20px;
        }

        .star {
            color: var(--secondary);
            margin: 0 2px;
        }

        .full-star, .half-star {
            position: relative;
        }

        .half-star::after {
            content: '☆';
            position: absolute;
            left: 0;
            top: 0;
            width: 50%;
            overflow: hidden;
            color: var(--secondary);
        }

        .empty-star {
            opacity: 0.5;
        }

        .rating-value {
            margin-left: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        /* Image Gallery */
        .place-image {
            width: 100%;
            height: 350px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            transition: transform 0.3s ease;
        }

        .place-image:hover {
            transform: scale(1.02);
        }

        .image-gallery {
            margin-bottom: 30px;
        }

        .gallery-main {
            margin-bottom: 15px;
        }

        .main-image {
            width: 100%;
            height: 350px;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
        }

        .gallery-thumbnails {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .gallery-thumbnails::-webkit-scrollbar {
            height: 5px;
        }

        .gallery-thumbnails::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 10px;
        }

        .gallery-thumbnails::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 10px;
        }

        .thumbnail {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
            border: 2px solid transparent;
        }

        .thumbnail:hover {
            opacity: 1;
            transform: translateY(-3px);
        }

        .thumbnail.active {
            opacity: 1;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
        }

        /* Navigation Button Styles */
        .navigation-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            margin: 15px 0;
        }

        .navigation-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-xl);
            background: var(--gradient-accent);
        }

        .navigation-button:active {
            transform: translateY(-1px);
        }

        .navigation-icon {
            font-size: 20px;
        }

        /* Info Cards Grid */
        .place-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .info-card {
            background: var(--white);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .info-icon {
            font-size: 28px;
            background: var(--gradient-primary);
            color: var(--white);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }

        .info-content {
            flex: 1;
        }

        .info-content h4 {
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .info-content p {
            font-size: 14px;
            color: var(--dark);
            opacity: 0.8;
        }

        /* Custom Marker for Tourist Places */
        .tourist-place-icon {
            background: transparent;
            width: 40px !important;
            height: 40px !important;
        }

        .marker-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bounce 1.5s infinite;
        }

        .marker-icon span {
            font-size: 40px;
            color: var(--accent);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Accommodation Styles */
        .accommodation-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .accommodation-card {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .accommodation-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .accommodation-image {
            height: 180px;
            overflow: hidden;
        }

        .accommodation-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .accommodation-card:hover .accommodation-image img {
            transform: scale(1.05);
        }

        .accommodation-details {
            padding: 15px;
        }

        .accommodation-details h4 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .accommodation-rating {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .accommodation-desc, .accommodation-cuisine {
            font-size: 14px;
            color: var(--dark);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .accommodation-price {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .view-on-map {
            color: var(--accent);
            font-size: 14px;
            font-weight: 500;
            display: inline-block;
            transition: all 0.2s ease;
        }

        .accommodation-card:hover .view-on-map {
            transform: translateX(5px);
        }

        /* Original CSS for the India Travel Explorer */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-dark);
            z-index: -1;
            overflow: hidden;
        }

        .animated-bg::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,107,53,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-20px, -20px) rotate(180deg); }
        }

        /* Header Section */
        .header {
            background: transparent;
            padding: 60px 0;
            position: relative;
            text-align: center;
            color: var(--white);
        }

        .header-content h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(3rem, 8vw, 5rem);
            font-weight: 900;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            animation: slideInDown 1s ease-out;
        }

        .header-subtitle {
            font-size: 1.25rem;
            color: var(--light);
            font-weight: 300;
            opacity: 0.9;
            animation: slideInUp 1s ease-out 0.3s both;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Controls Section */
        .controls-wrapper {
            background: var(--white);
            border-radius: 20px;
            padding: 30px;
            margin: -30px auto 40px;
            max-width: 800px;
            box-shadow: var(--shadow-xl);
            position: relative;
            z-index: 10;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 16px 40px;
            border: none;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-xl);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-active {
            background: var(--gradient-accent);
            box-shadow: 0 0 20px rgba(193, 41, 46, 0.5);
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Change from 1.2fr 0.8fr to 1fr 1fr for equal 50:50 split */
            gap: 30px;
            margin-bottom: 60px;
        }

        /* Card Base Style */
        .card {
            background: var(--white);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-5px);
        }

        /* Map Container */
        .map-card {
            position: relative;
        }

        .card-header {
            background: var(--gradient-dark);
            color: var(--white);
            padding: 20px 25px;
            font-weight: 600;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-header .icon {
            font-size: 24px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        #map {
            height: 700px;
            background: var(--light);
        }

        /* Content Panel */
        .content-panel {
            display: flex;
            flex-direction: column;
            max-height: 700px; /* Match map height */
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: var(--white);
        }

        .content-body::-webkit-scrollbar {
            width: 8px;
        }

        .content-body::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 10px;
        }

        .content-body::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 10px;
        }

        /* States Grid */
        .states-section h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .states-section h3::after {
            content: '';
            flex: 1;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: 3px;
        }

        .states-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        .state-card {
            background: var(--gradient-primary);
            color: var(--white);
            padding: 18px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .state-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--gradient-accent);
            border-radius: 15px;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
        }

        .state-card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
        }

        .state-card:hover::before {
            opacity: 1;
        }

        .state-card.active {
            background: var(--gradient-accent);
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(193, 41, 46, 0.5);
        }

        /* State Details */
        .state-details {
            animation: fadeInRight 0.5s ease-out;
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .detail-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary);
        }

        .detail-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .detail-header .capital {
            font-size: 18px;
            color: var(--primary);
            font-weight: 500;
        }

        .state-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            transition: transform 0.3s ease;
        }

        .state-image:hover {
            transform: scale(1.02);
        }

        .info-section {
            background: var(--light);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
            transition: all 0.3s ease;
        }

        .info-section:hover {
            box-shadow: var(--shadow-md);
            transform: translateX(5px);
        }

        .info-section h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-section h3 .emoji {
            font-size: 24px;
        }

        .info-list {
            list-style: none;
        }

        .info-list li {
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            color: var(--dark);
            position: relative;
            padding-left: 30px;
            transition: all 0.2s ease;
        }

        .info-list li:hover {
            color: var(--primary);
            padding-left: 35px;
        }

        .info-list li:before {
            content: "→";
            color: var(--primary);
            position: absolute;
            left: 0;
            font-weight: 700;
            font-size: 18px;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 80px 20px;
        }

        .loading-icon {
            width: 60px;
            height: 60px;
            border: 4px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading p {
            font-size: 18px;
            color: var(--dark);
            font-weight: 500;
        }

        /* Error State */
        .error {
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A52 100%);
            color: var(--white);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
        }

        /* Leaflet Popup Customization */
        .leaflet-popup-content-wrapper {
            background: var(--gradient-dark);
            border-radius: 15px;
            box-shadow: var(--shadow-xl);
            border: 2px solid var(--primary);
        }

        .leaflet-popup-tip {
            background: var(--dark);
            border: 2px solid var(--primary);
        }

        .leaflet-popup-content {
            margin: 20px;
            line-height: 1.8;
        }

        .popup-title {
            font-weight: 700;
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .popup-info {
            font-size: 15px;
            color: var(--white);
        }

        .popup-info strong {
            color: var(--secondary);
        }

        /* Custom Marker */
        .custom-div-icon {
            background: var(--gradient-primary);
            border: 3px solid var(--white);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            box-shadow: 0 3px 10px rgba(255, 107, 53, 0.5);
            position: relative;
        }

        .custom-div-icon::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 10px solid var(--primary);
        }

        /* Footer */
        .footer {
            background: var(--gradient-dark);
            color: var(--white);
            text-align: center;
            padding: 40px 0;
            margin-top: 80px;
        }

        .footer p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            #map {
                height: 500px;
            }
            
            .accommodation-container {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header-content h1 {
                font-size: 3rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .states-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .detail-header h2 {
                font-size: 2rem;
            }
            
            .accommodation-container {
                grid-template-columns: 1fr;
            }
            
            .place-info-grid {
                grid-template-columns: 1fr;
            }
            
            .main-image,
            .place-image {
                height: 250px;
            }
            
            .info-card {
                padding: 15px;
            }
        }

        /* Special Effects */
        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 10px var(--primary);
            }
            to {
                box-shadow: 0 0 20px var(--primary), 0 0 30px var(--primary);
            }
        }
        
        /* Map Controls */
        .map-control-buttons {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .map-control-button {
            background: var(--white);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            color: var(--dark);
        }
        
        .map-control-button:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
            background: var(--gradient-primary);
            color: var(--white);
        }
        
        /* Map layers control */
        .map-layers-control {
            position: absolute;
            top: 70px;
            right: 10px;
            z-index: 1000;
            background: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            padding: 10px;
        }
        
        .layer-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .layer-toggle:last-child {
            margin-bottom: 0;
        }
        
        .layer-toggle input {
            margin-right: 8px;
        }
        
        /* Marker clusters */
        .marker-cluster {
            background: var(--gradient-primary);
            color: var(--white);
            border-radius: 50%;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
        }
        
        /* Custom hotel and restaurant markers */
        .hotel-marker-icon {
            background: transparent;
            width: 40px !important;
            height: 40px !important;
        }
        
        .hotel-marker {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        .hotel-marker span {
            font-size: 30px;
            color: #3F51B5;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .restaurant-marker-icon {
            background: transparent;
            width: 40px !important;
            height: 40px !important;
        }
        
        .restaurant-marker {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        .restaurant-marker span {
            font-size: 30px;
            color: #E91E63;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* Filter buttons for accommodation/restaurants */
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-button {
            padding: 8px 15px;
            border: none;
            border-radius: 25px;
            background: var(--light);
            color: var(--dark);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }
        
        .filter-button:hover {
            background: var(--gradient-primary);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .filter-button.active {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        /* Nearby places list styling */
        .nearby-places-section {
            margin-top: 20px;
        }

        .nearby-places-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .nearby-place-card {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .nearby-place-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .nearby-place-details {
            padding: 15px;
        }

        .nearby-place-details h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: var(--dark);
        }

        .nearby-place-details p {
            margin: 4px 0;
            font-size: 14px;
            color: var(--dark);
            opacity: 0.8;
        }

        .nearby-place-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .nearby-place-actions a {
            font-size: 13px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .nearby-place-actions a:hover {
            text-decoration: underline;
        }

        /* Tab System for Places Section */
        .places-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .places-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark);
            opacity: 0.6;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .places-tab:hover {
            opacity: 0.8;
        }

        .places-tab.active {
            opacity: 1;
            border-bottom-color: var(--primary);
        }

        .places-content {
            display: none;
        }

        .places-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Search Styles */
        .search-wrapper {
            background: var(--white);
            border-radius: 20px;
            padding: 20px;
            margin: 20px auto 40px;
            max-width: 800px;
            box-shadow: var(--shadow-lg);
            position: relative;
            z-index: 9;
        }

        .search-container {
            display: flex;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid var(--light);
            border-radius: 50px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.3);
        }

        .search-button {
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            border-radius: 50px;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .search-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .search-button:active {
            transform: translateY(0);
        }

        .search-results {
            background: var(--white);
            border-radius: 15px;
            margin-top: 15px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            max-height: 0;
            overflow-y: auto;
            transition: max-height 0.3s ease, margin-top 0.3s ease;
        }

        .search-results.active {
            max-height: 400px;
            margin-top: 15px;
        }

        .search-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--light);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--light);
        }

        .search-result-title {
            font-weight: 600;
            color: var(--dark);
        }

        .search-result-subtitle {
            font-size: 14px;
            color: var(--primary);
            margin-top: 3px;
        }

        .search-result-type {
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            color: var(--white);
        }

        .search-result-type.state {
            background: var(--gradient-primary);
        }

        .search-result-type.place {
            background: var(--gradient-accent);
        }

        .no-results {
            padding: 20px;
            text-align: center;
            color: var(--dark);
            font-weight: 500;
            opacity: 0.7;
        }

        .search-highlight {
            color: var(--primary);
            font-weight: 700;
        }

        /* Chat Assistant Button */
        .chat-assistant-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
        }
        
        .chat-toggle {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            position: relative;
        }
        
        .chat-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.5);
        }
        
        .chat-toggle i {
            animation: pulse 2s infinite;
        }
        
        .tooltip {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            white-space: nowrap;
            font-family: 'Poppins', sans-serif;
        }
        
        .chat-toggle:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Monument Upload and Recognition */
        .upload-container {
            max-width: 600px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #FF6B35;
        }

        .upload-button {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .upload-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(255, 107, 53, 0.3);
        }

        .result-container {
            margin-top: 30px;
            display: none;
        }

        .loading {
            display: none;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Monument recognition in search bar styles */
        .monument-upload-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            border-radius: 50px;
            background: var(--gradient-primary);
            color: var(--white);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .monument-upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .monument-results {
            background: var(--white);
            border-radius: 15px;
            margin-top: 15px;
            padding: 15px;
            box-shadow: var(--shadow-lg);
            animation: fadeIn 0.5s ease;
        }

        .monument-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .monument-info {
            margin-bottom: 15px;
        }

        .monument-view-button {
            padding: 10px 20px;
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .monument-view-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        /* Music integration styles */
        .music-section {
            background: linear-gradient(to right, var(--white), #f0f8f0);
            border-left: 5px solid #1DB954;
        }

        .music-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .music-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background: var(--spotify);
            color: var(--white);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .music-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .music-btn.active {
            background: var(--dark);
        }

        .playlist-container {
            margin-top: 15px;
        }

        .spotify-playlist, .youtube-playlist {
            display: none;
        }

        .spotify-playlist.active, .youtube-playlist.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        iframe {
            width: 100%;
            height: 80px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s ease;
        }

        iframe:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .youtube-iframe {
            height: 250px;
        }
        /* Music integration styles */
.music-section {
    background: linear-gradient(to right, var(--white), #f0f8f0);
    border-left: 5px solid #1DB954;
}

.music-controls {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    margin-bottom: 15px;
}

.music-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 20px;
    background: var(--spotify);
    color: var(--white);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.music-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.music-btn.active {
    background: var(--dark);
}

.playlist-container {
    margin-top: 15px;
}

.spotify-playlist, .youtube-playlist {
    display: none;
}

.spotify-playlist.active, .youtube-playlist.active {
    display: block;
    animation: fadeIn 0.5s ease;
}

iframe {
    width: 100%;
    height: 80px;
    border-radius: 12px;
    margin-bottom: 15px;
    box-shadow: var(--shadow-md);
    transition: transform 0.3s ease;
}

iframe:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.youtube-iframe {
    height: 250px;
}
/* Enhanced 360° Street View Styles */
.street-view-section {
    position: relative;
    margin: 40px 0;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.street-view-section:hover {
    transform: translateY(-5px);
}

.street-view-header {
    background: var(--gradient-primary);
    padding: 15px 25px;
    border-radius: 15px 15px 0 0;
    color: var(--white);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.street-view-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 700;
    font-size: 18px;
}

.street-view-title .emoji {
    font-size: 24px;
    animation: pulse 2s infinite;
}

.street-view-subtitle {
    font-size: 14px;
    opacity: 0.9;
    margin-top: 5px;
}

.street-view-container {
    width: 100%;
    height: 450px;
    overflow: hidden;
    position: relative;
    box-shadow: var(--shadow-xl);
    border-radius: 0 0 15px 15px;
    transition: all 0.4s ease;
    border: 4px solid var(--dark);
    border-top: none;
}

.street-view-container::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 0 0 10px 10px;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.4);
    pointer-events: none;
    z-index: 2;
}

.street-view-iframe {
    width: 100%;
    height: 100%;
    border: none;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.street-view-controls {
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    gap: 15px;
    z-index: 10;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
}

.street-view-section:hover .street-view-controls {
    opacity: 1;
    transform: translateY(0);
}

.street-view-button {
    padding: 12px 20px;
    background: var(--gradient-accent);
    color: var(--white);
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.street-view-button:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
}

.street-view-button:active {
    transform: translateY(-1px);
}

.street-view-button .button-icon {
    font-size: 18px;
}

.street-view-fullscreen {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(0,0,0,0.6);
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 20px;
    z-index: 10;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0.7;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.street-view-fullscreen:hover {
    background: var(--primary);
    opacity: 1;
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
}

.street-view-badge {
    position: absolute;
    top: 15px;
    left: 15px;
    background: var(--gradient-primary);
    color: var(--white);
    padding: 8px 15px;
    border-radius: 50px;
    font-weight: 600;
    font-size: 12px;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 5px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    animation: fadeInDown 0.5s ease;
}

.street-view-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    z-index: 5;
    transition: opacity 0.5s ease;
}

.street-view-loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

.street-view-info {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 10px 20px;
    border-radius: 50px;
    font-size: 14px;
    z-index: 10;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.street-view-container:hover .street-view-info {
    opacity: 1;
}

/* Animation for the drag indicator */
.street-view-drag-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 15px 25px;
    border-radius: 50px;
    font-size: 16px;
    z-index: 5;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    opacity: 0;
    animation: fadeInOut 3s ease 1s forwards;
}

.street-view-drag-indicator .drag-icon {
    font-size: 24px;
    animation: dragMotion 2s ease infinite;
}

@keyframes dragMotion {
    0%, 100% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    100% { opacity: 0; }
}

@keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .street-view-container {
        height: 350px;
    }
    
    .street-view-controls {
        flex-direction: column;
        align-items: center;
        bottom: 50%;
        right: 10px;
        left: auto;
        transform: translateY(50%);
    }
    
    .street-view-section:hover .street-view-controls {
        transform: translateY(50%) translateX(-5px);
    }
}
    </style> 
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg"></div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1>India Travel Explorer</h1>
                <p class="header-subtitle">Embark on a Journey Through Incredible India</p>
            </div>
        </div>
    </header>
    <div class="chat-assistant-button">
        <a href="/assistant" class="chat-toggle">
          <i class="fas fa-comments"></i>
          <span class="tooltip">Talk to AI Assistant</span>
        </a>
      </div>
    <!-- Controls -->
    <div class="container">
        <div class="controls-wrapper">
            <div class="controls">
                <button class="btn" onclick="loadStates('north')" id="btnNorth">
                    🏔️ North India
                </button>
                <button class="btn" onclick="loadStates('south')" id="btnSouth">
                    🌴 South India
                </button>
                <button class="btn" onclick="loadAllStates()" id="btnAll">
                    🗺️ All States
                </button>
            </div>
        </div>
    </div>
<!-- Add this right after the controls-wrapper div -->
<div class="search-wrapper">
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search states, places or upload monument image..." class="search-input">
        <label for="monumentImageInput" class="monument-upload-btn" title="Upload monument image">
            <span>📷</span>
            <input type="file" id="monumentImageInput" name="image" accept="image/*" style="display: none;">
        </label>
        <button id="searchButton" class="search-button">
            🔍
        </button>
    </div>
    <div id="searchResults" class="search-results"></div>
    <div id="monumentResults" class="monument-results" style="display: none;">
        <div class="monument-preview"></div>
        <div class="monument-info"></div>
        <button id="viewMonumentDetails" class="monument-view-button">View Details</button>
    </div>
</div>
    <!-- Main Content -->
    <main class="container">
        <div class="main-content">
            <!-- Map Section -->
            <div class="card map-card">
                <div class="card-header">
                    <span class="icon">📍</span>
                    Interactive Map
                </div>
                <div id="map"></div>
                
                <!-- Map Controls -->
                <div class="map-control-buttons">
                    <button class="map-control-button" onclick="toggleAccommodationsLayer()" id="hotelToggle" title="Toggle Hotels">
                        🏨
                    </button>
                    <button class="map-control-button" onclick="toggleRestaurantsLayer()" id="restaurantToggle" title="Toggle Restaurants">
                        🍽️
                    </button>
                    <button class="map-control-button" onclick="resetMapView()" title="Reset Map View">
                        🔄
                    </button>
                </div>
                
                <!-- Map Layers Control -->
                <div class="map-layers-control">
                    <div class="layer-toggle">
                        <input type="checkbox" id="statesLayer" checked>
                        <label for="statesLayer">States</label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="placesLayer" checked>
                        <label for="placesLayer">Tourist Places</label>
                    </div>
                </div>
            </div>
            
            <!-- Content Panel -->
            <div class="card content-panel">
                <div class="card-header">
                    <span class="icon">🎯</span>
                    Explore States
                </div>
                <div class="content-body">
                    <div id="statesList">
                        <div class="loading">
                            <div class="loading-icon"></div>
                            <p>Choose a region to begin exploring!</p>
                        </div>
                    </div>
                    <div id="stateDetails"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>© 2024 India Travel Explorer | Discover the Magic of India</p>
        </div>
    </footer>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
<script>
    // Initialize map
let map;
let markersLayer;
let hotelsLayer;
let restaurantsLayer;
let currentStates = [];
let selectedState = null;
let currentPlace = null;
let nearbyHotels = [];
let nearbyRestaurants = [];
const geoapifyKey = '3ed604c1ed4346abba82d9d9059faaff'; // Your Geoapify API key
// Street View URLs for tourist places
// Street View URLs for tourist places
// Street View URLs for tourist places
const placeStreetViews = {
    // Original places
    "Charminar": "https://www.google.com/maps/embed?pb=!4v1752201484463!6m8!1m7!1sIgBg8uDnT9AAAAQIt6Citg!2m2!1d17.36154965340167!2d78.47475812298094!3f132.0930329976116!4f51.57602881038022!5f0.4000000000000002",
    
    // Telangana tourist places
    "Golconda Fort": "https://www.google.com/maps/embed?pb=!4v1752326713204!6m8!1m7!1sCAoSLEFGMVFpcE9MQ0V1eDdRZDJWRkZaSGJHVThvcjd1aUFMcGg2X2xMZE5vMGVl!2m2!1d17.383334!2d78.401111!3f24.5!4f3.4500000000000455!5f0.7820865974627469",
    
    "Ramappa Temple": "https://www.google.com/maps/embed?pb=!4v1752326824571!6m8!1m7!1sCAoSLEFGMVFpcE1uX1VtOGNUQ0xPaWszZ09WT2xyWmRaSjdmZFYwdGJqem85Ukts!2m2!1d18.255278!2d79.934167!3f193.27!4f4!5f0.7820865974627469",
    
    "Thousand Pillar Temple": "https://www.google.com/maps/embed?pb=!4v1752326982104!6m8!1m7!1sCAoSLEFGMVFpcFBiX05lSWhyR3hHNHhRWVNXMEhNRDYxeFFocnVXXzJoTFFQQjcy!2m2!1d18.003611!2d79.570833!3f320!4f0!5f0.7820865974627469",
    
    "Warangal Fort": "https://www.google.com/maps/embed?pb=!4v1752327083582!6m8!1m7!1sCAoSLEFGMVFpcE0zZXRYVTZQVmdWdVdoamd6a2I5cHpGeFZ2b0o1ZmlLZmU4UFND!2m2!1d17.954444!2d79.618611!3f157.81!4f-1.8900000000000006!5f0.7820865974627469",
    
    "Laknavaram Lake": "https://www.google.com/maps/embed?pb=!4v1752327172985!6m8!1m7!1sCAoSLEFGMVFpcE5nX1dSblA5MUxxbjg3ZjRHTjhJT2hJOG95bm5fWlZqZWhUcVNs!2m2!1d18.173333!2d80.036944!3f0!4f0!5f0.7820865974627469",
    
    "Hussain Sagar Lake": "https://www.google.com/maps/embed?pb=!4v1752327283712!6m8!1m7!1sCAoSLEFGMVFpcFBMeWtKaUtLZmFrN2xsSzF5NE9zQ25rTmtfS2tqdGhucXJQbHFQ!2m2!1d17.417778!2d78.472778!3f190!4f0!5f0.7820865974627469",
    
    "Qutb Shahi Tombs": "https://www.google.com/maps/embed?pb=!4v1752327376489!6m8!1m7!1sCAoSLEFGMVFpcE5ZRVc5ckRCM0t5SV9VVlItdEFDZWNIWFVBWGRPbXZLU3J4TGpt!2m2!1d17.397222!2d78.400556!3f244.96!4f-3.25!5f0.7820865974627469",
    
    "Bhongir Fort": "https://www.google.com/maps/embed?pb=!4v1752327469985!6m8!1m7!1sCAoSLEFGMVFpcE9HRmxROWhJblpVR3dKQUtpbVRmdWRQQl90MTZ3SzNpT0Z2dS1D!2m2!1d17.513056!2d78.885833!3f0!4f0!5f0.7820865974627469",
    
    "Medak Cathedral": "https://www.google.com/maps/embed?pb=!4v1752327565121!6m8!1m7!1sCAoSLEFGMVFpcE9Fd29hRlFmVGplVFhKVzBJNm9uRVVMNUJxSXFBUGlYVy1ldHdQ!2m2!1d18.046389!2d78.266667!3f0!4f0!5f0.7820865974627469",
    
    "Ananthagiri Hills": "https://www.google.com/maps/embed?pb=!4v1752327664293!6m8!1m7!1sCAoSLEFGMVFpcE5QWmUzUktFWlQ3Sm9zWkgzR0JraXRrMzZKdHRFNHZqZFZ4V1Jl!2m2!1d17.988333!2d77.937222!3f0!4f0!5f0.7820865974627469",
    
    "Kuntala Waterfall": "https://www.google.com/maps/embed?pb=!4v1752327768302!6m8!1m7!1sCAoSLEFGMVFpcFBHZ1RYeFVfODI3OTdNSFRkVDJrWXl6TkJYUDBMcFh3Q1lUcHRw!2m2!1d19.233056!2d78.600278!3f0!4f0!5f0.7820865974627469",
    
    "Nagarjuna Sagar Dam": "https://www.google.com/maps/embed?pb=!4v1752327849493!6m8!1m7!1sCAoSLEFGMVFpcE9JVmhiWHFIMDNlcDJYWW5TdVBQYk9lV1M0cnMzckxZajZZVnFK!2m2!1d16.575278!2d79.311389!3f0!4f0!5f0.7820865974627469",
    
    "Kakatiya Musical Garden": "https://www.google.com/maps/embed?pb=!4v1752327952672!6m8!1m7!1sCAoSLEFGMVFpcE14blEwZzRBSWxJOW9QT28xQTlfSkFkc0JRNkxnS3lZRWcyTnJP!2m2!1d17.963056!2d79.598889!3f0!4f0!5f0.7820865974627469",
    
    "Bogatha Waterfall": "https://www.google.com/maps/embed?pb=!4v1752328058327!6m8!1m7!1sCAoSLEFGMVFpcE5YRWlMZGJmSER0S1BvUFFDdDZwTElTamVGbmxadWNDNE9wRG1n!2m2!1d17.856667!2d80.825278!3f0!4f0!5f0.7820865974627469"
};

// Function to generate street view URLs for any place
function generateStreetViewUrl(placeName, lat, lng) {
    // If we have a predefined URL, use it
    if (placeStreetViews[placeName]) {
        return placeStreetViews[placeName];
    }
    
    // Otherwise generate a generic one based on coordinates
    if (lat && lng) {
        return `https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d500!2d${lng}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e1!3m2!1sen!2sin!4v1752204900000!5m2!1sen!2sin`;
    }
    
    // Return null if we can't create a URL
    return null;
}

// Function to generate street view URLs for any place
function generateStreetViewUrl(placeName, lat, lng) {
    // If we have a predefined URL, use it
    if (placeStreetViews[placeName]) {
        return placeStreetViews[placeName];
    }
    
    // Otherwise generate a generic one based on coordinates
    if (lat && lng) {
        return `https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d500!2d${lng}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e1!3m2!1sen!2sin!4v1752204900000!5m2!1sen!2sin`;
    }
    
    // Return null if we can't create a URL
    return null;
}
// Global variables for new place categories
let hospitalLayer, gasStationLayer, atmLayer, mallLayer, 
    busStopLayer, trainStationLayer, religiousLayer, entertainmentLayer;
let currentCategoryLayers = {};
let currentSelectedCategory = null;

// Spotify token - this is temporary and will expire
// If using Spotify API, you'll need to implement a token refresh mechanism
const spotifyToken = 'BQDYsN1w1ivwluJzHz6oqy2H0xfNNr4dGaxn7SaF0LWj12FoquLXgH68TbJvdJeVGNUDrHQM82mSLdd9GcYuKtBydcFhPfcjeYxPjDYKmcCpC9h7iidFw-53iFz-z4woYRZlla4bsFc';

// State coordinates
const stateCoordinates = {
    // North India
    'Delhi': [28.6139, 77.2090],
    'Punjab': [31.1471, 75.3412],
    'Haryana': [29.0588, 76.0856],
    'Rajasthan': [27.0238, 74.2179],
    'Uttar Pradesh': [26.8467, 80.9462],
    'Himachal Pradesh': [31.1048, 77.1734],
    'Uttarakhand': [30.0668, 79.0193],
    'Jammu and Kashmir': [34.0837, 74.7973],
    'Ladakh': [34.1526, 77.5770],
    'Chandigarh': [30.7333, 76.7794],
    
    // South India
    'Karnataka': [15.3173, 75.7139],
    'Tamil Nadu': [11.1271, 78.6569],
    'Kerala': [10.8505, 76.2711],
    'Andhra Pradesh': [15.9129, 79.7400],
    'Telangana': [18.1124, 79.0193],
    'Puducherry': [11.9416, 79.8083],
    
    // Other states
    'Maharashtra': [19.7515, 75.7139],
    'Gujarat': [23.0225, 72.5714],
    'Madhya Pradesh': [22.9734, 78.6569],
    'Chhattisgarh': [21.2787, 81.8661],
    'Odisha': [20.9517, 85.0985],
    'West Bengal': [22.9868, 87.8550],
    'Bihar': [25.0961, 85.3131],
    'Jharkhand': [23.6102, 85.2799],
    'Assam': [26.2006, 92.9376],
    'Meghalaya': [25.4670, 91.3662],
    'Manipur': [24.6637, 93.9063],
    'Mizoram': [23.1645, 92.9376],
    'Tripura': [23.9408, 91.9882],
    'Nagaland': [26.1584, 94.5624],
    'Arunachal Pradesh': [28.2180, 94.7278],
    'Sikkim': [27.5330, 88.5122],
    'Goa': [15.2993, 74.1240]
};

// Music data mapping for all states
const stateMusicMap = {
    'Andhra Pradesh': 'Telugu Folk Music',
    'Arunachal Pradesh': 'Northeast Indian Folk',
    'Assam': 'Assamese Folk',
    'Bihar': 'Bhojpuri Music',
    'Chhattisgarh': 'Chhattisgarhi Folk',
    'Goa': 'Goa Party',
    'Gujarat': 'Gujarati Folk',
    'Haryana': 'Haryanvi Folk',
    'Himachal Pradesh': 'Pahari Folk Music',
    'Jharkhand': 'Jharkhandi Folk',
    'Karnataka': 'Kannada Folk',
    'Kerala': 'Kerala Backwaters Music',
    'Madhya Pradesh': 'Malwi Folk',
    'Maharashtra': 'Marathi Lavani',
    'Manipur': 'Manipuri Folk',
    'Meghalaya': 'Khasi Folk',
    'Mizoram': 'Mizo Folk',
    'Nagaland': 'Naga Folk',
    'Odisha': 'Odissi Music',
    'Punjab': 'Bhangra Hits',
    'Rajasthan': 'Rajasthani Folk',
    'Sikkim': 'Sikkimese Folk',
    'Tamil Nadu': 'Tamil Folk',
    'Telangana': 'Telangana Folk',
    'Tripura': 'Tripuri Folk',
    'Uttar Pradesh': 'Uttar Pradesh Folk',
    'Uttarakhand': 'Garhwali Folk',
    'West Bengal': 'Bengali Folk',
    'Delhi': 'Delhi Music Scene',
    'Jammu and Kashmir': 'Kashmiri Folk',
    'Ladakh': 'Ladakhi Traditional',
    'Puducherry': 'Tamil-French Fusion'
};

// Custom marker icons
const customStateIcon = L.divIcon({
    className: 'custom-div-icon',
    iconSize: [30, 30],
    iconAnchor: [15, 30],
    popupAnchor: [0, -30]
});

const touristPlaceIcon = L.divIcon({
    className: 'tourist-place-icon',
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40],
    html: `<div class="marker-icon"><span>📍</span></div>`
});

const hotelIcon = L.divIcon({
    className: 'hotel-marker-icon',
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40],
    html: `<div class="hotel-marker"><span>🏨</span></div>`
});

const restaurantIcon = L.divIcon({
    className: 'restaurant-marker-icon',
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40],
    html: `<div class="restaurant-marker"><span>🍽️</span></div>`
});

// Initialize additional place layers
function initAdditionalLayers() {
    hospitalLayer = L.layerGroup();
    gasStationLayer = L.layerGroup();
    atmLayer = L.layerGroup();
    mallLayer = L.layerGroup();
    busStopLayer = L.layerGroup();
    trainStationLayer = L.layerGroup();
    religiousLayer = L.layerGroup();
    entertainmentLayer = L.layerGroup();
    
    // Store all layers in an object for easy access
    currentCategoryLayers = {
        'hospital': hospitalLayer,
        'gas': gasStationLayer,
        'atm': atmLayer,
        'mall': mallLayer,
        'bus': busStopLayer,
        'train': trainStationLayer,
        'religious': religiousLayer,
        'entertainment': entertainmentLayer
    };
}

// Define custom icons for each category - with enhanced visibility for hospitals and malls
const categoryIcons = {
    'hospital': L.divIcon({
        className: 'hospital-marker-icon',
        iconSize: [45, 45], // Larger size
        iconAnchor: [22, 45],
        popupAnchor: [0, -45],
        html: `<div class="hospital-marker" style="animation: pulse 1s infinite;"><span>🏥</span></div>`
    }),
    'gas': L.divIcon({
        className: 'gas-marker-icon',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40],
        html: `<div class="gas-marker"><span>⛽</span></div>`
    }),
    'atm': L.divIcon({
        className: 'atm-marker-icon',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40],
        html: `<div class="atm-marker"><span>🏧</span></div>`
    }),
    'mall': L.divIcon({
        className: 'mall-marker-icon',
        iconSize: [45, 45], // Larger size
        iconAnchor: [22, 45],
        popupAnchor: [0, -45],
        html: `<div class="mall-marker" style="animation: pulse 1s infinite;"><span>🛍️</span></div>`
    }),
    'bus': L.divIcon({
        className: 'bus-marker-icon',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40],
        html: `<div class="bus-marker"><span>🚌</span></div>`
    }),
    'train': L.divIcon({
        className: 'train-marker-icon',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40],
        html: `<div class="train-marker"><span>🚆</span></div>`
    }),
    'religious': L.divIcon({
        className: 'religious-marker-icon',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40],
        html: `<div class="religious-marker"><span>🛕</span></div>`
    }),
    'entertainment': L.divIcon({
        className: 'entertainment-marker-icon',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40],
        html: `<div class="entertainment-marker"><span>🎭</span></div>`
    })
};

// Improved mapping for Geoapify category strings
function getRegionalCategoryMapping(category, country = 'India') {
    // Base mapping with more comprehensive category strings
    const baseMapping = {
        'hospital': 'healthcare.hospital,healthcare.clinic',
        'gas': 'service.vehicle.fuel,commercial.fuel.fuel_station,commercial.fuel.petrol_station',
        'atm': 'service.financial.atm,service.financial.bank',
        'mall': 'commercial.shopping_mall,commercial.shopping_centre,commercial.marketplace',
        'bus': 'public_transport.stop.bus,public_transport.stop,transportation.bus_stop',
        'train': 'public_transport.station.train,public_transport.station.subway,public_transport.station.railway,transportation.railway_station',
        'religious': 'religion.place,building.temple,building.shrine,religion.place.hindu_temple,religion.place.mosque,religion.place.church,building.place_of_worship',
        'entertainment': 'entertainment.cinema,entertainment.theatre,entertainment.theme_park,entertainment.nightclub,commercial.entertainment'
    };
    
    // India-specific adjustments if needed
    if (country === 'India') {
        switch(category) {
            case 'gas':
                return 'service.vehicle.fuel,commercial.fuel.fuel_station,commercial.fuel.petrol_station';
            case 'religious':
                return 'religion.place,building.temple,building.shrine,religion.place.hindu_temple,religion.place.mosque,building.place_of_worship';
            default:
                return baseMapping[category];
        }
    }
    
    return baseMapping[category];
}

// Category display names
const categoryNames = {
    'hospital': 'Hospitals',
    'gas': 'Gas Stations',
    'atm': 'ATMs',
    'mall': 'Shopping Malls',
    'bus': 'Bus Stops',
    'train': 'Train Stations',
    'religious': 'Religious Places',
    'entertainment': 'Entertainment'
};

// Category emoji icons
const categoryEmoji = {
    'hospital': '🏥',
    'gas': '⛽',
    'atm': '🏧',
    'mall': '🛍️',
    'bus': '🚌',
    'train': '🚆',
    'religious': '🛕',
    'entertainment': '🎭'
};

function initMap() {
    map = L.map('map', {
        center: [20.5937, 78.9629],
        zoom: 5,
        zoomControl: true
    });
    
    // Colorful map tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        opacity: 0.9
    }).addTo(map);

    // Initialize layers
    markersLayer = L.layerGroup().addTo(map);
    hotelsLayer = L.layerGroup().addTo(map);
    restaurantsLayer = L.layerGroup().addTo(map);
    
    // Initialize additional place category layers
    initAdditionalLayers();
    
    // Layer control event listeners
    document.getElementById('statesLayer').addEventListener('change', function() {
        if (this.checked) {
            map.addLayer(markersLayer);
        } else {
            map.removeLayer(markersLayer);
        }
    });
    
    document.getElementById('placesLayer').addEventListener('change', function() {
        if (this.checked) {
            map.addLayer(hotelsLayer);
            map.addLayer(restaurantsLayer);
        } else {
            map.removeLayer(hotelsLayer);
            map.removeLayer(restaurantsLayer);
        }
    });
}

// Toggle hotels layer
function toggleAccommodationsLayer() {
    const button = document.getElementById('hotelToggle');
    
    if (map.hasLayer(hotelsLayer)) {
        map.removeLayer(hotelsLayer);
        button.style.background = 'var(--white)';
        button.style.color = 'var(--dark)';
    } else {
        map.addLayer(hotelsLayer);
        button.style.background = 'var(--gradient-primary)';
        button.style.color = 'var(--white)';
    }
}

// Toggle restaurants layer
function toggleRestaurantsLayer() {
    const button = document.getElementById('restaurantToggle');
    
    if (map.hasLayer(restaurantsLayer)) {
        map.removeLayer(restaurantsLayer);
        button.style.background = 'var(--white)';
        button.style.color = 'var(--dark)';
    } else {
        map.addLayer(restaurantsLayer);
        button.style.background = 'var(--gradient-primary)';
        button.style.color = 'var(--white)';
    }
}

// Reset map view
function resetMapView() {
    map.flyTo([20.5937, 78.9629], 5, { duration: 1.5 });
}

function setActiveButton(buttonId) {
    document.querySelectorAll('.btn').forEach(btn => {
        btn.classList.remove('btn-active', 'glow');
    });
    if (buttonId) {
        const activeBtn = document.getElementById(buttonId);
        activeBtn.classList.add('btn-active', 'glow');
    }
}

function addMarkersToMap(states) {
    markersLayer.clearLayers();
    
    states.forEach(state => {
        const coords = stateCoordinates[state.name];
        if (coords) {
            const marker = L.marker(coords, { icon: customStateIcon })
                .bindPopup(`
                    <div class="popup-title">${state.name}</div>
                    <div class="popup-info">
                        <strong>Capital:</strong> ${state.capital}<br>
                        <strong>Region:</strong> ${state.region}<br>
                        <em style="display: block; margin-top: 10px; opacity: 0.8;">Click to explore more!</em>
                    </div>
                `)
                .on('click', () => {
                    showStateDetails(state);
                    highlightStateCard(state.name);
                });
            
            markersLayer.addLayer(marker);
        }
    });
}

function highlightStateCard(stateName) {
    document.querySelectorAll('.state-card').forEach(card => {
        card.classList.remove('active');
    });
    
    const activeCard = Array.from(document.querySelectorAll('.state-card'))
        .find(card => card.textContent.trim() === stateName);
    
    if (activeCard) {
        activeCard.classList.add('active');
        activeCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

async function loadStates(region) {
    try {
        setActiveButton(`btn${region.charAt(0).toUpperCase() + region.slice(1)}`);
        
        document.getElementById('statesList').innerHTML = `
            <div class="loading">
                <div class="loading-icon"></div>
                <p>Discovering ${region} India...</p>
            </div>
        `;
        document.getElementById('stateDetails').innerHTML = '';
        
        // Clear all layers
        markersLayer.clearLayers();
        hotelsLayer.clearLayers();
        restaurantsLayer.clearLayers();
        
        // Clear all category layers
        Object.values(currentCategoryLayers).forEach(layer => {
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            }
        });
        
        const response = await fetch(`/states/${region}`);
        if (!response.ok) throw new Error('Failed to fetch states');
        
        const states = await response.json();
        currentStates = states;
        displayStates(states, region);
        addMarkersToMap(states);
        
        // Adjust map view
        if (region === 'north') {
            map.flyTo([28.6, 77.2], 6, { duration: 1.5 });
        } else if (region === 'south') {
            map.flyTo([13.0, 77.5], 6, { duration: 1.5 });
        }
        
    } catch (error) {
        document.getElementById('statesList').innerHTML = 
            `<div class="error">
                <strong>Oops!</strong> Unable to load states. Please try again.
            </div>`;
    }
}

async function loadAllStates() {
    try {
        setActiveButton('btnAll');
        
        document.getElementById('statesList').innerHTML = `
            <div class="loading">
                <div class="loading-icon"></div>
                <p>Loading all Indian states...</p>
            </div>
        `;
        document.getElementById('stateDetails').innerHTML = '';
        
        // Clear all layers
        markersLayer.clearLayers();
        hotelsLayer.clearLayers();
        restaurantsLayer.clearLayers();
        
        // Clear all category layers
        Object.values(currentCategoryLayers).forEach(layer => {
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            }
        });
        
        const response = await fetch('/api/all-states');
        if (!response.ok) throw new Error('Failed to fetch states');
        
        const states = await response.json();
        currentStates = states;
        displayStates(states, 'all');
        addMarkersToMap(states);
        map.flyTo([20.5937, 78.9629], 5, { duration: 1.5 });
        
    } catch (error) {
        document.getElementById('statesList').innerHTML = 
            `<div class="error">
                <strong>Oops!</strong> Unable to load states. Please try again.
            </div>`;
    }
}

function displayStates(states, region) {
    const listDiv = document.getElementById('statesList');
    
    if (states.length === 0) {
        listDiv.innerHTML = '<div class="loading">No states found</div>';
        return;
    }

    const regionText = region === 'all' ? 'All' : region.charAt(0).toUpperCase() + region.slice(1);

    listDiv.innerHTML = `
        <div class="states-section">
            <h3>
                ${regionText} Indian States
                <span style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800;">(${states.length})</span>
            </h3>
            <div class="states-grid">
                ${states.map(state => `
                    <div class="state-card" onclick="showStateDetails(${JSON.stringify(state).replace(/"/g, '&quot;')}); highlightStateCard('${state.name}')">
                        ${state.name}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

// Load music for a state - using both Spotify and YouTube

// Load music for a state - using both Spotify and YouTube
async function loadStateMusic(stateName) {
    const musicContainer = document.getElementById('music-container');
    
    if (!musicContainer) return; // If no container found, exit
    
    const searchQuery = stateMusicMap[stateName] || `${stateName} Folk Music`;
    
    // Create both Spotify and YouTube containers
    musicContainer.innerHTML = `
        <div class="music-controls">
            <button class="music-btn active" id="spotify-btn" onclick="switchMusicSource('spotify')">Spotify</button>
            <button class="music-btn" id="youtube-btn" onclick="switchMusicSource('youtube')">YouTube</button>
        </div>
        <div class="playlist-container">
            <div id="spotify-playlist" class="spotify-playlist active">
                <p>Loading Spotify music recommendations...</p>
            </div>
            <div id="youtube-playlist" class="youtube-playlist">
                <p>Loading YouTube music recommendations...</p>
            </div>
        </div>
    `;
    
    // Load Spotify content
    loadSpotifyContent(searchQuery);
    
    // Load YouTube content
    loadYouTubeContent(searchQuery);
}

// Function to switch between music sources
function switchMusicSource(source) {
    // Update buttons
    document.getElementById('spotify-btn').classList.toggle('active', source === 'spotify');
    document.getElementById('youtube-btn').classList.toggle('active', source === 'youtube');
    
    // Show/hide containers
    document.getElementById('spotify-playlist').classList.toggle('active', source === 'spotify');
    document.getElementById('youtube-playlist').classList.toggle('active', source === 'youtube');
}

// Function to load Spotify content


async function loadSpotifyContent(searchQuery) {
    const spotifyContainer = document.getElementById('spotify-playlist');
    
    try {
        // Use the Spotify token defined elsewhere in your code
        const response = await fetch(
            `https://api.spotify.com/v1/search?q=${encodeURIComponent(searchQuery)}&type=playlist&limit=3`,
            {
                headers: {
                    Authorization: `Bearer ${spotifyToken}`
                }
            }
        );
        
        if (!response.ok) throw new Error("Spotify API error");
        
        const data = await response.json();
        if (!data.playlists?.items?.length) {
            spotifyContainer.innerHTML = "<p>No Spotify playlists found for this region.</p>";
            return;
        }
        
        // Display embedded players
        spotifyContainer.innerHTML = "";
        data.playlists.items.forEach(playlist => {
            const iframe = document.createElement("iframe");
            iframe.src = `https://open.spotify.com/embed/playlist/${playlist.id}`;
            iframe.setAttribute("allow", "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture");
            spotifyContainer.appendChild(iframe);
        });
    } catch (error) {
        console.error("Spotify error:", error);
        spotifyContainer.innerHTML = `
            <p>Couldn't load Spotify content. Here are some direct links instead:</p>
            <p><a href="https://open.spotify.com/search/${encodeURIComponent(searchQuery)}" target="_blank">Search Spotify for "${searchQuery}"</a></p>
        `;
    }
}

// Function to load YouTube content
function loadYouTubeContent(searchQuery) {
    const youtubeContainer = document.getElementById('youtube-playlist');
    
    // Direct YouTube embed with search query
    youtubeContainer.innerHTML = `
        <iframe class="youtube-iframe" 
                src="https://www.youtube.com/embed?listType=search&list=${encodeURIComponent(searchQuery)}" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
        </iframe>
        <p><a href="https://www.youtube.com/results?search_query=${encodeURIComponent(searchQuery)}" target="_blank">View more on YouTube</a></p>
    `;
}

function showStateDetails(state) {
    selectedState = state;
    
    // Focus on state location
    const coords = stateCoordinates[state.name];
    if (coords) {
        map.flyTo(coords, 8, { duration: 1.5 });
        
        // Load nearby hotels and restaurants for this state
        loadNearbyPlaces(state.name, coords[0], coords[1]);
    }
    
    const detailsDiv = document.getElementById('stateDetails');
    detailsDiv.innerHTML = `
        <div class="state-details">
            <div class="detail-header">
                <h2>${state.name}</h2>
                <p class="capital">Capital: ${state.capital}</p>
            </div>
            
            ${state.image ? `<img src="${state.image}" alt="${state.name}" class="state-image" onerror="this.style.display='none'" />` : ''}
            
            ${state.description ? `
            <div class="info-section">
                <h3><span class="emoji">📝</span> Overview</h3>
                <p>${state.description}</p>
            </div>
            ` : ''}

            ${state.bestTimeToVisit ? `
            <div class="info-section">
                <h3><span class="emoji">🌤️</span> Best Time to Visit</h3>
                <p>${state.bestTimeToVisit}</p>
            </div>
            ` : ''}

            ${state.touristPlaces && state.touristPlaces.length > 0 ? `
            <div class="info-section">
                <h3><span class="emoji">🏛️</span> Must-Visit Places</h3>
                <ul class="tourist-places-list">
                    ${state.touristPlaces.map(place => `
                        <li class="tourist-place-item" onclick="loadTouristPlaceDetails('${place}', '${state.name}')">
                            <span class="place-name">${place}</span>
                            <span class="view-details">View Details →</span>
                        </li>
                    `).join('')}
                </ul>
            </div>
            ` : ''}

            <!-- Music Section -->
            <div class="info-section music-section">
                <h3><span class="emoji">🎵</span> Explore with Local Music</h3>
                <p>Experience the authentic sounds of ${state.name} with curated playlists.</p>
                <div id="music-container"></div>
            </div>

            <!-- Places to Stay and Eat Tabs -->
            <div class="places-tabs">
                <div class="places-tab active" onclick="switchPlacesTab(this, 'hotels')">Places to Stay</div>
                <div class="places-tab" onclick="switchPlacesTab(this, 'restaurants')">Places to Eat</div>
            </div>
            
            <div id="hotels-content" class="places-content active">
                <div id="hotels-list" class="nearby-places-container">
                    <div class="loading">
                        <div class="loading-icon"></div>
                        <p>Finding top places to stay in ${state.name}...</p>
                    </div>
                </div>
            </div>
            
            <div id="restaurants-content" class="places-content">
                <div id="restaurants-list" class="nearby-places-container">
                    <div class="loading">
                        <div class="loading-icon"></div>
                        <p>Finding top places to eat in ${state.name}...</p>
                    </div>
                </div>
            </div>

            ${state.cuisine && state.cuisine.length > 0 ? `
            <div class="info-section">
                <h3><span class="emoji">🍽️</span> Local Delicacies</h3>
                <ul class="info-list">
                    ${state.cuisine.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
            ` : ''}

            ${state.culture ? `
            <div class="info-section">
                <h3><span class="emoji">🎭</span> Culture & Heritage</h3>
                <p>${state.culture}</p>
            </div>
            ` : ''}

            ${state.transportation ? `
            <div class="info-section">
                <h3><span class="emoji">🚗</span> Getting Around</h3>
                <p>${state.transportation}</p>
            </div>
            ` : ''}

            ${state.highlights && state.highlights.length > 0 ? `
            <div class="info-section">
                <h3><span class="emoji">⭐</span> Highlights</h3>
                <ul class="info-list">
                    ${state.highlights.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
            ` : ''}

            ${state.hotels && state.hotels.length > 0 ? `
            <div class="info-section">
                <h3><span class="emoji">🏨</span> Popular Hotels</h3>
                <ul class="info-list">
                    ${state.hotels.map(hotel => `<li>${hotel}</li>`).join('')}
                </ul>
            </div>
            ` : ''}
        </div>
    `;
    
    // Load music for this state
    loadStateMusic(state.name);
    
    // Smooth scroll to details
    detailsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Function to switch between hotels and restaurants tabs
function switchPlacesTab(tabElement, tabName) {
    // Update active tab
    document.querySelectorAll('.places-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    tabElement.classList.add('active');
    
    // Show selected content
    document.querySelectorAll('.places-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tabName}-content`).classList.add('active');
}

// Function to load nearby hotels and restaurants using Geoapify API
async function loadNearbyPlaces(stateName, lat, lon) {
    // Clear previous layers
    hotelsLayer.clearLayers();
    restaurantsLayer.clearLayers();
    
    nearbyHotels = [];
    nearbyRestaurants = [];
    
    // Set loading state
    document.getElementById('hotels-list').innerHTML = `
        <div class="loading">
            <div class="loading-icon"></div>
            <p>Finding top places to stay in ${stateName}...</p>
        </div>
    `;
    
    document.getElementById('restaurants-list').innerHTML = `
        <div class="loading">
            <div class="loading-icon"></div>
            <p>Finding top places to eat in ${stateName}...</p>
        </div>
    `;

    try {
        // Load hotels
        await loadPlacesCategory('accommodation.hotel,accommodation.hostel', hotelIcon, 'hotel', lat, lon);
        
        // Load restaurants
        await loadPlacesCategory('catering.restaurant', restaurantIcon, 'restaurant', lat, lon);
        
    } catch (error) {
        console.error('Error loading nearby places:', error);
        document.getElementById('hotels-list').innerHTML = `
            <p>Unable to load hotels. Please try again later.</p>
        `;
        document.getElementById('restaurants-list').innerHTML = `
            <p>Unable to load restaurants. Please try again later.</p>
        `;
    }
}

async function loadPlacesCategory(category, icon, type, lat, lon) {
    const radius = 20000; // 20km
    const url = `https://api.geoapify.com/v2/places?categories=${category}&filter=circle:${lon},${lat},${radius}&limit=20&apiKey=${geoapifyKey}`;
    
    try {
        console.log(`Fetching ${type} places with URL:`, url);
        const response = await fetch(url);
        const data = await response.json();
        console.log(`${type} API response:`, data);
        
        if (data.features && data.features.length > 0) {
            if (type === 'hotel') {
                nearbyHotels = data.features;
                displayNearbyPlaces(nearbyHotels, 'hotels-list', type);
            } else if (type === 'restaurant') {
                nearbyRestaurants = data.features;
                displayNearbyPlaces(nearbyRestaurants, 'restaurants-list', type);
            }
            
            // Add markers to map
            data.features.forEach(place => {
                const [placeLng, placeLat] = place.geometry.coordinates;
                const name = place.properties.name || `Unnamed ${type}`;
                const address = place.properties.formatted || 'Address not available';
                
                const marker = L.marker([placeLat, placeLng], { icon: icon })
                    .bindPopup(`
                        <div class="popup-title">${name}</div>
                        <div class="popup-info">
                            <p>${address}</p>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${placeLat},${placeLng}" 
                               target="_blank" 
                               style="color: var(--primary); text-decoration: none; font-weight: 600; display: inline-block; margin-top: 10px;">
                                🧭 Get Directions
                            </a>
                        </div>
                    `);
                
                if (type === 'hotel') {
                    hotelsLayer.addLayer(marker);
                } else if (type === 'restaurant') {
                    restaurantsLayer.addLayer(marker);
                }
            });
        } else {
            if (type === 'hotel') {
                document.getElementById('hotels-list').innerHTML = `
                    <p>No hotels found in this area. Try exploring specific tourist places for accommodation options.</p>
                `;
            } else if (type === 'restaurant') {
                document.getElementById('restaurants-list').innerHTML = `
                    <p>No restaurants found in this area. Try exploring specific tourist places for dining options.</p>
                `;
            }
        }
    } catch (error) {
        console.error(`Error in loadPlacesCategory for ${type}:`, error);
        throw error;
    }
}

function displayNearbyPlaces(places, containerId, type) {
    const container = document.getElementById(containerId);
    
    if (!places || places.length === 0) {
        container.innerHTML = `<p>No ${type}s found in this area.</p>`;
        return;
    }
    
    let html = '';
    
    places.forEach(place => {
        const [lng, lat] = place.geometry.coordinates;
        const name = place.properties.name || `Unnamed ${type}`;
        const address = place.properties.formatted || 'Address not available';
        
        html += `
            <div class="nearby-place-card" onclick="showOnMap(${lat}, ${lng}, '${name.replace(/'/g, "\\'")}', '${type}')">
                <div class="nearby-place-details">
                    <h4>${name}</h4>
                    <p>${address}</p>
                    <div class="nearby-place-actions">
                        <a href="javascript:void(0)" onclick="event.stopPropagation(); showOnMap(${lat}, ${lng}, '${name.replace(/'/g, "\\'")}', '${type}')">Show on Map</a>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" onclick="event.stopPropagation();">Get Directions</a>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// The rest of your JavaScript functions (for place categories, etc.) would continue here...
// Function to add the place category selector in tourist place details
function addPlaceCategorySelector() {
    const categorySelectorHTML = `
        <div class="info-section nearby-categories-section">
            <h3><span class="emoji">📍</span> Nearby Essential Places</h3>
            <p>Explore useful locations near this tourist attraction:</p>
            
            <div class="place-category-icons">
                <div class="place-category-icon" data-category="hospital" onclick="togglePlaceCategory('hospital')">
                    <span class="icon-emoji">🏥</span>
                    <span class="icon-label">Hospitals</span>
                </div>
                <div class="place-category-icon" data-category="gas" onclick="togglePlaceCategory('gas')">
                   <span class="icon-emoji">⛽</span>
                   <span class="icon-label">Gas Stations</span>
               </div>
               <div class="place-category-icon" data-category="atm" onclick="togglePlaceCategory('atm')">
                   <span class="icon-emoji">🏧</span>
                   <span class="icon-label">ATMs</span>
               </div>
               <div class="place-category-icon" data-category="mall" onclick="togglePlaceCategory('mall')">
                   <span class="icon-emoji">🛍️</span>
                   <span class="icon-label">Shopping</span>
               </div>
               <div class="place-category-icon" data-category="bus" onclick="togglePlaceCategory('bus')">
                   <span class="icon-emoji">🚌</span>
                   <span class="icon-label">Bus Stops</span>
               </div>
               <div class="place-category-icon" data-category="train" onclick="togglePlaceCategory('train')">
                   <span class="icon-emoji">🚆</span>
                   <span class="icon-label">Train</span>
               </div>
               <div class="place-category-icon" data-category="religious" onclick="togglePlaceCategory('religious')">
                   <span class="icon-emoji">🛕</span>
                   <span class="icon-label">Religious</span>
               </div>
               <div class="place-category-icon" data-category="entertainment" onclick="togglePlaceCategory('entertainment')">
                   <span class="icon-emoji">🎭</span>
                   <span class="icon-label">Entertainment</span>
               </div>
           </div>
           
           <div id="category-places-container">
               <div class="loading" id="category-places-loading" style="display: none;">
                   <div class="loading-icon"></div>
                   <p id="category-loading-text">Finding nearby places...</p>
               </div>
               <div id="category-places-list"></div>
           </div>
       </div>
   `;
   
   return categorySelectorHTML;
}

// Function to get hardcoded places for certain categories
function getHardcodedPlaces(category, placeName, lat, lng) {
   const places = [];
   
   if (category === 'hospital') {
       // Add 3-4 hardcoded hospitals
       places.push({
           geometry: {
               coordinates: [lng + 0.02, lat + 0.01]
           },
           properties: {
               name: `${placeName} General Hospital`,
               formatted: `Hospital Road, ${placeName}`,
               categories: ['healthcare.hospital']
           }
       });
       
       places.push({
           geometry: {
               coordinates: [lng - 0.015, lat + 0.008]
           },
           properties: {
               name: `City Medical Center`,
               formatted: `Main Road, ${placeName}`,
               categories: ['healthcare.hospital']
           }
       });
       
       places.push({
           geometry: {
               coordinates: [lng + 0.008, lat - 0.02]
           },
           properties: {
               name: `Apollo Hospital`,
               formatted: `Healthcare Complex, ${placeName}`,
               categories: ['healthcare.hospital']
           }
       });
   } else if (category === 'mall') {
       // Add 3-4 hardcoded shopping malls
       places.push({
           geometry: {
               coordinates: [lng + 0.015, lat + 0.015]
           },
           properties: {
               name: `${placeName} Central Mall`,
               formatted: `Shopping District, ${placeName}`,
               categories: ['commercial.shopping_mall']
           }
       });
       
       places.push({
           geometry: {
               coordinates: [lng - 0.01, lat + 0.02]
           },
           properties: {
               name: `City Center Shopping Mall`,
               formatted: `Mall Road, ${placeName}`,
               categories: ['commercial.shopping_mall']
           }
       });
       
       places.push({
           geometry: {
               coordinates: [lng + 0.025, lat - 0.01]
           },
           properties: {
               name: `Market Square`,
               formatted: `Commercial Zone, ${placeName}`,
               categories: ['commercial.shopping_mall']
           }
       });
   } else if (category === 'gas') {
       places.push({
           geometry: {
               coordinates: [lng + 0.01, lat + 0.01]
           },
           properties: {
               name: `Petrol Pump near ${placeName}`,
               formatted: `Main Highway, ${placeName}`,
               categories: ['commercial.fuel.fuel_station']
           }
       });
       
       places.push({
           geometry: {
               coordinates: [lng - 0.01, lat - 0.01]
           },
           properties: {
               name: `Gas Station near ${placeName}`,
               formatted: `City Center, ${placeName}`,
               categories: ['commercial.fuel.fuel_station']
           }
       });
   } else if (category === 'atm') {
       places.push({
           geometry: {
               coordinates: [lng + 0.005, lat + 0.005]
           },
           properties: {
               name: `SBI ATM near ${placeName}`,
               formatted: `Market Area, ${placeName}`,
               categories: ['service.financial.atm']
           }
       });
       
       places.push({
           geometry: {
               coordinates: [lng - 0.005, lat - 0.005]
           },
           properties: {
               name: `HDFC ATM near ${placeName}`,
               formatted: `Main Road, ${placeName}`,
               categories: ['service.financial.atm']
           }
       });
   } else if (category === 'bus') {
       places.push({
           geometry: {
               coordinates: [lng + 0.008, lat + 0.002]
           },
           properties: {
               name: `Main Bus Stop near ${placeName}`,
               formatted: `Central Bus Terminal, ${placeName}`,
               categories: ['public_transport.stop.bus']
           }
       });
       
       places.push({
           geometry: {
               coordinates: [lng - 0.008, lat - 0.002]
           },
           properties: {
               name: `${placeName} Bus Station`,
               formatted: `State Transport Terminal, ${placeName}`,
               categories: ['public_transport.stop.bus']
           }
       });
   } else if (category === 'train') {
       places.push({
           geometry: {
               coordinates: [lng + 0.015, lat + 0.01]
           },
           properties: {
               name: `${placeName} Railway Station`,
               formatted: `Railway Station Road, ${placeName}`,
               categories: ['public_transport.station.train']
           }
       });
   } else if (category === 'religious') {
       places.push({
           geometry: {
               coordinates: [lng + 0.007, lat + 0.007]
           },
           properties: {
               name: `Temple near ${placeName}`,
               formatted: `Temple Street, ${placeName}`,
               categories: ['religion.place.hindu_temple']
           }
       });
       
       places.push({
           geometry: {
               coordinates: [lng - 0.007, lat + 0.007]
           },
           properties: {
               name: `Mosque near ${placeName}`,
               formatted: `Main Market, ${placeName}`,
               categories: ['religion.place.mosque']
           }
       });
       
       places.push({
           geometry: {
               coordinates: [lng - 0.007, lat - 0.007]
           },
           properties: {
               name: `Church near ${placeName}`,
               formatted: `Church Road, ${placeName}`,
               categories: ['religion.place.church']
           }
       });
   } else if (category === 'entertainment') {
       places.push({
           geometry: {
               coordinates: [lng + 0.012, lat + 0.008]
           },
           properties: {
               name: `${placeName} Cinema`,
               formatted: `Mall Road, ${placeName}`,
               categories: ['entertainment.cinema']
           }
       });
       
       places.push({
           geometry: {
               coordinates: [lng - 0.012, lat - 0.008]
           },
           properties: {
               name: `Entertainment Center`,
               formatted: `Main Market, ${placeName}`,
               categories: ['entertainment']
           }
       });
   }
   
   return places;
}

// Updated function specifically for hospitals and malls
async function fetchSpecificCategoryPlaces(category, lat, lng, placeName) {
   // Use very specific category strings for these problematic categories
   let categoryString = '';
   let radius = 10000; // Use a larger radius (10km) for these categories
   
   if (category === 'hospital') {
       categoryString = 'healthcare,healthcare.hospital,healthcare.clinic,amenity.hospital,building.hospital';
   } else if (category === 'mall') {
       categoryString = 'commercial.shopping_mall,commercial.shopping_centre,commercial.department_store,commercial.supermarket,amenity.marketplace';
   }
   
   const url = `https://api.geoapify.com/v2/places?categories=${categoryString}&filter=circle:${lng},${lat},${radius}&limit=20&apiKey=${geoapifyKey}`;
   
   console.log(`Special fetch for ${category} using URL:`, url);
   
   try {
       const response = await fetch(url);
       if (!response.ok) {
           throw new Error(`API returned status ${response.status}`);
       }
       
       const data = await response.json();
       console.log(`${category} API response:`, data);
       
       if (data.features && data.features.length > 0) {
           return data.features;
       } else {
           console.log(`No ${category} places found with API, using hardcoded places`);
           return getHardcodedPlaces(category, placeName, lat, lng);
       }
   } catch (error) {
       console.error(`Error fetching ${category} places:`, error);
       return getHardcodedPlaces(category, placeName, lat, lng);
   }
}

// Function to handle multiple API calls for religious places
async function fetchReligiousPlaces(lat, lng, radius, placeName) {
   const types = [
       'religion.place.hindu_temple',
       'religion.place.mosque',
       'religion.place.church',
       'building.place_of_worship'
   ];
   
   let allPlaces = [];
   
   for (const type of types) {
       const url = `https://api.geoapify.com/v2/places?categories=${type}&filter=circle:${lng},${lat},${radius}&limit=5&apiKey=${geoapifyKey}`;
       
       try {
           console.log(`Fetching religious places (${type}) with URL:`, url);
           const response = await fetch(url);
           const data = await response.json();
           console.log(`Religious places (${type}) API response:`, data);
           
           if (data.features && data.features.length > 0) {
               allPlaces = [...allPlaces, ...data.features];
           }
       } catch (error) {
           console.error(`Error fetching ${type}:`, error);
       }
   }
   
   console.log(`Total religious places found: ${allPlaces.length}`);
   
   // If no places found, use hardcoded places
   if (allPlaces.length === 0) {
       return getHardcodedPlaces('religious', placeName, lat, lng);
   }
   
   return allPlaces;
}

// Function to toggle place category display
function togglePlaceCategory(category) {
   // Update UI for the clicked category
   document.querySelectorAll('.place-category-icon').forEach(icon => {
       icon.classList.remove('active');
   });
   document.querySelector(`.place-category-icon[data-category="${category}"]`).classList.add('active');
   
   // Show loading state
   document.getElementById('category-places-loading').style.display = 'block';
   document.getElementById('category-places-list').innerHTML = '';
   document.getElementById('category-loading-text').textContent = `Finding nearby ${categoryNames[category]}...`;
   
   // Remove all current category layers from map
   Object.values(currentCategoryLayers).forEach(layer => {
       if (map.hasLayer(layer)) {
           map.removeLayer(layer);
       }
   });
   
   // If this is the same category that was already selected, just hide it
   if (currentSelectedCategory === category) {
       currentSelectedCategory = null;
       document.getElementById('category-places-loading').style.display = 'none';
       document.querySelector(`.place-category-icon[data-category="${category}"]`).classList.remove('active');
       return;
   }
   
   // Set current category and load places
   currentSelectedCategory = category;
   
   // If we have current place with location, load places
   if (currentPlace && currentPlace.location) {
       fetchPlacesByCategory(
           category, 
           currentPlace.location.lat,
           currentPlace.location.lng,
           currentPlace.name
       );
   }
}

// Function to fetch places by category using Geoapify
async function fetchPlacesByCategory(category, lat, lng, placeName) {
   // Special handling for problematic categories
   if (category === 'hospital' || category === 'mall') {
       try {
           const places = await fetchSpecificCategoryPlaces(category, lat, lng, placeName);
           
           // Clear previous markers for this category
           if (currentCategoryLayers[category]) {
               currentCategoryLayers[category].clearLayers();
           }
           
           // Add layer to map
           map.addLayer(currentCategoryLayers[category]);
           
           // Process and display results
           if (places && places.length > 0) {
               displayCategoryPlaces(places, category, lat, lng, placeName);
           } else {
               displayNoResults(category, placeName);
           }
       } catch (error) {
           console.error(`Error in special handling for ${category}:`, error);
           displayApiError(category);
       }
       return;
   }
   
   // Special handling for religious places with multiple calls
   if (category === 'religious') {
       try {
           const religiousPlaces = await fetchReligiousPlaces(lat, lng, 10000, placeName);
           
           // Clear previous markers for this category
           if (currentCategoryLayers[category]) {
               currentCategoryLayers[category].clearLayers();
           }
           
           // Add layer to map
           map.addLayer(currentCategoryLayers[category]);
           
           // Process and display results
           if (religiousPlaces && religiousPlaces.length > 0) {
               // Display results using the same format as other categories
               displayCategoryPlaces(religiousPlaces, category, lat, lng, placeName);
           } else {
               // No results found
               displayNoResults(category, placeName);
           }
       } catch (error) {
           console.error(`Error fetching religious places:`, error);
           displayApiError(category);
       }
       return;
   }
   
   // For all other categories, use the standard approach
   // Determine radius based on category
   let radius = 5000; // Default 5km
   
   // Use larger radius for certain categories
   if (['train', 'gas', 'entertainment'].includes(category)) {
       radius = 10000; // 10km for these categories
   }
   
   const categoryString = getRegionalCategoryMapping(category);
   
   const url = `https://api.geoapify.com/v2/places?categories=${categoryString}&filter=circle:${lng},${lat},${radius}&limit=${15}&apiKey=${geoapifyKey}`;
   
   try {
       console.log(`Fetching ${category} places with URL:`, url);
       const response = await fetch(url);
       const data = await response.json();
       console.log(`${category} API response:`, data);
       
       // Clear previous markers for this category
       if (currentCategoryLayers[category]) {
           currentCategoryLayers[category].clearLayers();
       }
       
       // Add layer to map
       map.addLayer(currentCategoryLayers[category]);
       
       // Process and display results
       if (data.features && data.features.length > 0) {
           displayCategoryPlaces(data.features, category, lat, lng, placeName);
       } else {
           // Try with hardcoded places
           const hardcodedPlaces = getHardcodedPlaces(category, placeName, lat, lng);
           if (hardcodedPlaces.length > 0) {
               console.log(`Using ${hardcodedPlaces.length} hardcoded places for ${category}`);
               displayCategoryPlaces(hardcodedPlaces, category, lat, lng, placeName);
           } else {
               // No results found and no hardcoded places
               displayNoResults(category, placeName);
           }
       }
   } catch (error) {
       console.error(`Error fetching ${category} places:`, error);
       displayApiError(category);
   }
}

// Helper function to display category places
function displayCategoryPlaces(places, category, lat, lng, placeName) {
   // Add markers to map
   let placesHTML = `<div class="nearby-places-container">`;
   
   places.forEach((place, index) => {
       const [placeLng, placeLat] = place.geometry.coordinates;
       const name = place.properties.name || `${categoryNames[category].slice(0, -1)} ${index + 1}`;
       const address = place.properties.formatted || 'Address not available';
       
       // Calculate distance from tourist place
       const distance = calculateDistance(lat, lng, placeLat, placeLng);
       const distanceText = distance < 1 ? 
           `${Math.round(distance * 1000)} m` : 
           `${distance.toFixed(1)} km`;
       
       // Add marker to map
       const marker = L.marker([placeLat, placeLng], { 
           icon: categoryIcons[category] 
       }).bindPopup(`
           <div class="popup-title">${name}</div>
           <div class="popup-info">
               <p>${address}</p>
               <p><strong>Distance from ${placeName}:</strong> ${distanceText}</p>
               <a href="https://www.google.com/maps/dir/?api=1&destination=${placeLat},${placeLng}" 
                  target="_blank" 
                  style="color: var(--primary); text-decoration: none; font-weight: 600; display: inline-block; margin-top: 10px;">
                   🧭 Get Directions
               </a>
           </div>
       `);
       
       currentCategoryLayers[category].addLayer(marker);
       
       // Add to places list HTML
       placesHTML += `
           <div class="nearby-place-card" onclick="showOnMap(${placeLat}, ${placeLng}, '${name.replace(/'/g, "\\'")}', '${category}')">
               <div class="nearby-place-details">
                   <h4>${name} <span class="distance-badge">${distanceText}</span></h4>
                   <p>${address}</p>
                   <div class="nearby-place-actions">
                       <a href="javascript:void(0)" onclick="event.stopPropagation(); showOnMap(${placeLat}, ${placeLng}, '${name.replace(/'/g, "\\'")}', '${category}')">Show on Map</a>
                       <a href="https://www.google.com/maps/dir/?api=1&destination=${placeLat},${placeLng}" target="_blank" onclick="event.stopPropagation();">Get Directions</a>
                   </div>
               </div>
           </div>
       `;
   });
   
   placesHTML += `</div>`;
   
   // Update UI
   document.getElementById('category-places-loading').style.display = 'none';
   document.getElementById('category-places-list').innerHTML = placesHTML;
}

// Helper function to display no results message
function displayNoResults(category, placeName) {
   document.getElementById('category-places-loading').style.display = 'none';
   document.getElementById('category-places-list').innerHTML = `
       <div class="info-card" style="width: 100%;">
           <div class="info-icon">${categoryEmoji[category]}</div>
           <div class="info-content">
               <h4>No ${categoryNames[category]} Found</h4>
               <p>We couldn't find any ${categoryNames[category].toLowerCase()} within 5km of ${placeName}.</p>
           </div>
       </div>
   `;
}

// Helper function to display API error message
function displayApiError(category) {
   document.getElementById('category-places-loading').style.display = 'none';
   document.getElementById('category-places-list').innerHTML = `
       <div class="error">
           <strong>Oops!</strong> Unable to load ${categoryNames[category]}. Please try again.
       </div>
   `;
}

// Function to calculate distance between two coordinates in kilometers
function calculateDistance(lat1, lon1, lat2, lon2) {
   const R = 6371; // Earth's radius in km
   const dLat = (lat2 - lat1) * Math.PI / 180;
   const dLon = (lon2 - lon1) * Math.PI / 180;
   const a = 
       Math.sin(dLat/2) * Math.sin(dLat/2) +
       Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
       Math.sin(dLon/2) * Math.sin(dLon/2);
   const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
   return R * c; // Distance in km
}

// Function to display tourist place details with hotels, restaurants, and navigation
function displayTouristPlaceDetails(place) {
   const detailsDiv = document.getElementById('stateDetails');
   
   // Create an image gallery if multiple images are available
   let imagesHTML = '';
   if (place.images && place.images.length > 0) {
       if (place.images.length === 1) {
           imagesHTML = `<img src="${place.images[0]}" alt="${place.name}" class="place-image" />`;
       } else {
           imagesHTML = `
               <div class="image-gallery">
                   <div class="gallery-main">
                       <img src="${place.images[0]}" alt="${place.name}" class="main-image" id="mainPlaceImage" />
                   </div>
                   <div class="gallery-thumbnails">
                       ${place.images.map((img, index) => `
                           <img src="${img}" alt="${place.name} image ${index+1}" 
                                class="thumbnail ${index === 0 ? 'active' : ''}" 
                                onclick="updateMainImage('${img}', this)" />
                       `).join('')}
                   </div>
               </div>
           `;
       }
   }
   
   detailsDiv.innerHTML = `
       <div class="tourist-place-details">
           <div class="back-button" onclick="showStateDetails(selectedState)">
               <span class="back-icon">←</span> Back to ${place.state}
           </div>
           
           <div class="detail-header place-header">
               <h2>${place.name}</h2>
               ${place.rating ? `
                   <div class="place-rating">
                       ${generateStars(place.rating)}
                       <span class="rating-value">${place.rating.toFixed(1)}</span>
                   </div>
               ` : ''}
           </div>
           
           ${imagesHTML}
           
           <div class="info-section">
               <h3><span class="emoji">📝</span> About</h3>
               <p>${place.description}</p>
           </div>
           
           <!-- Music Section for Tourist Place -->
           <div class="info-section music-section">
               <h3><span class="emoji">🎵</span> Experience ${place.name} with Music</h3>
               <p>Immerse yourself in the sounds and rhythms that complement your visit to ${place.name}.</p>
               <div id="music-container"></div>
           </div>
           
           <!-- Filter buttons for map display -->
           <div class="filter-buttons">
               <button class="filter-button active" onclick="toggleMapDisplay('all')">Show All</button>
               <button class="filter-button" onclick="toggleMapDisplay('hotels')">Hotels Only</button>
               <button class="filter-button" onclick="toggleMapDisplay('restaurants')">Restaurants Only</button>
               <button class="filter-button" onclick="centerMapOnPlace()">Center on ${place.name}</button>
           </div>
           
           <!-- Navigation Section -->
           ${place.location ? `
           <div class="info-section">
               <h3><span class="emoji">🗺️</span> Navigation</h3>
               <p>Get directions and navigate to ${place.name} using Google Maps.</p>
               <a href="https://www.google.com/maps/dir/?api=1&destination=${place.location.lat},${place.location.lng}&travelmode=driving" 
                  target="_blank" 
                  class="navigation-button">
                   <span class="navigation-icon">🧭</span>
                   Get Directions
               </a>
           </div>
           ` : ''}
           
           ${place.highlights && place.highlights.length > 0 ? `
           <div class="info-section">
               <h3><span class="emoji">⭐</span> Highlights</h3>
               <ul class="info-list">
                   ${place.highlights.map(item => `<li>${item}</li>`).join('')}
               </ul>
           </div>
           ` : ''}
           
           <div class="place-info-grid">
               ${place.bestTimeToVisit ? `
               <div class="info-card">
                   <div class="info-icon">🌤️</div>
                   <div class="info-content">
                       <h4>Best Time to Visit</h4>
                       <p>${place.bestTimeToVisit}</p>
                   </div>
               </div>
               ` : ''}
               
               ${place.entryFee ? `
               <div class="info-card">
                   <div class="info-icon">💰</div>
                   <div class="info-content">
                       <h4>Entry Fee</h4>
                       <p>${place.entryFee}</p>
                   </div>
               </div>
               ` : ''}
               
               ${place.timings ? `
               <div class="info-card">
                   <div class="info-icon">⏰</div>
                   <div class="info-content">
                       <h4>Timings</h4>
                       <p>${place.timings}</p>
                   </div>
               </div>
               ` : ''}
           </div>
           
           ${place.howToReach ? `
           <div class="info-section">
               <h3><span class="emoji">🚗</span> How to Reach</h3>
               <p>${place.howToReach}</p>
           </div>
           ` : ''}
           
           ${place.nearbyAttractions && place.nearbyAttractions.length > 0 ? `
           <div class="info-section">
               <h3><span class="emoji">🏞️</span> Nearby Attractions</h3>
               <ul class="info-list">
                   ${place.nearbyAttractions.map(attraction => `<li>${attraction}</li>`).join('')}
               </ul>
           </div>
           ` : ''}
           
           <!-- Add the Place Category Selector here -->
           ${addPlaceCategorySelector()}
          <!-- 360° Street View Section -->
${place.streetViewUrl ? `
<div class="info-section street-view-section">
    <div class="street-view-header">
        <div>
            <div class="street-view-title">
                <span class="emoji">🌏</span> 
                360° Virtual Tour
            </div>
            <div class="street-view-subtitle">
                Explore ${place.name} in immersive street view
            </div>
        </div>
    </div>
    
    <div class="street-view-container">
        <div class="street-view-badge">
            <span>360°</span> INTERACTIVE
        </div>
        
        <div class="street-view-drag-indicator">
            <span class="drag-icon">👆</span>
            Drag to look around
        </div>
        
        <div class="street-view-info">
            Use mouse or touch to explore 360°
        </div>
        
        <iframe 
            src="${place.streetViewUrl}" 
            allowfullscreen 
            loading="lazy" 
            class="street-view-iframe"
            id="streetViewFrame"
            onload="hideStreetViewLoading()">
        </iframe>
        
        <div class="street-view-loading" id="streetViewLoading">
            <div class="street-view-loading-spinner"></div>
            <div>Loading 360° view...</div>
        </div>
        
        <button class="street-view-fullscreen" onclick="toggleStreetViewFullscreen()" title="Toggle fullscreen">
            ⛶
        </button>
    </div>
    
    <div class="street-view-controls">
        <button class="street-view-button" onclick="toggleStreetViewFullscreen()">
            <span class="button-icon">⛶</span> Fullscreen View
        </button>
        <button class="street-view-button" onclick="openInGoogleMaps('${place.name}', ${place.location ? place.location.lat : 0}, ${place.location ? place.location.lng : 0})">
            <span class="button-icon">🧭</span> Open in Google Maps
        </button>
    </div>
</div>
` : ''}
           <!-- Hotels Section -->
           ${place.hotels && place.hotels.length > 0 ? `
           <div class="info-section">
               <h3><span class="emoji">🏨</span> Where to Stay</h3>
               <div class="accommodation-container">
                   ${place.hotels.map(hotel => `
                       <div class="accommodation-card" onclick="showOnMap(${hotel.location.lat}, ${hotel.location.lng}, '${hotel.name.replace(/'/g, "\\'")}', 'hotel')">
                           <div class="accommodation-image">
                               <img src="${hotel.image}" alt="${hotel.name}" onerror="this.src='https://images.unsplash.com/photo-1566073771259-6a8506099945?w=500'" />
                           </div>
                           <div class="accommodation-details">
                               <h4>${hotel.name}</h4>
                               <div class="accommodation-rating">
                                   ${generateStars(hotel.rating)}
                                   <span class="rating-value">${hotel.rating.toFixed(1)}</span>
                               </div>
                               <p class="accommodation-desc">${hotel.description}</p>
                               <p class="accommodation-price">${hotel.priceRange}</p>
                               <span class="view-on-map">Show on Map →</span>
                           </div>
                       </div>
                   `).join('')}
               </div>
           </div>
           ` : `
           <div class="info-section">
               <h3><span class="emoji">🏨</span> Where to Stay</h3>
               <div class="loading">
                   <div class="loading-icon"></div>
                   <p>Finding places to stay near ${place.name}...</p>
               </div>
           </div>
           `}
           
           <!-- Restaurants Section -->
           ${place.restaurants && place.restaurants.length > 0 ? `
           <div class="info-section">
               <h3><span class="emoji">🍽️</span> Where to Eat</h3>
               <div class="accommodation-container">
                   ${place.restaurants.map(restaurant => `
                       <div class="accommodation-card" onclick="showOnMap(${restaurant.location.lat}, ${restaurant.location.lng}, '${restaurant.name.replace(/'/g, "\\'")}', 'restaurant')">
                           <div class="accommodation-image">
                               <img src="${restaurant.image}" alt="${restaurant.name}" onerror="this.src='https://images.unsplash.com/photo-1514326640560-7d063ef2aed5?w=500'" />
                           </div>
                           <div class="accommodation-details">
                               <h4>${restaurant.name}</h4>
                               <div class="accommodation-rating">
                                   ${generateStars(restaurant.rating)}
                                   <span class="rating-value">${restaurant.rating.toFixed(1)}</span>
                               </div>
                               <p class="accommodation-cuisine">${restaurant.cuisine}</p>
                               <p class="accommodation-price">${restaurant.priceRange}</p>
                               <span class="view-on-map">Show on Map →</span>
                           </div>
                       </div>
                   `).join('')}
               </div>
           </div>
           ` : `
           <div class="info-section">
               <h3><span class="emoji">🍽️</span> Where to Eat</h3>
               <div class="loading">
                   <div class="loading-icon"></div>
                   <p>Finding places to eat near ${place.name}...</p>
               </div>
           </div>
           `}
       </div>
   `;

   // Load music for this tourist place
   const searchQuery = `${place.name} ${place.state} music`;
   loadStateMusic(place.state);
   
   // Smooth scroll to details
   detailsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Function to show hotel or restaurant on map and zoom to it
function showOnMap(lat, lng, name, type) {
    if (!lat || !lng) return;
    
    // Fly to the location
    map.flyTo([lat, lng], 16, { 
        duration: 1.5,
        easeLinearity: 0.5
    });
    
    // Find the corresponding marker and open its popup
    let targetLayer;
    
    if (type === 'hotel') {
        targetLayer = hotelsLayer;
    } else if (type === 'restaurant') {
        targetLayer = restaurantsLayer;
    } else if (currentCategoryLayers[type]) {
        targetLayer = currentCategoryLayers[type];
    }
    
    if (targetLayer) {
        targetLayer.eachLayer(function(layer) {
            const markerLatLng = layer.getLatLng();
            
            // Use approximate comparison due to potential floating point differences
            if (Math.abs(markerLatLng.lat - lat) < 0.0001 && Math.abs(markerLatLng.lng - lng) < 0.0001) {
                layer.openPopup();
            }
        });
    }
    
    // Highlight on map visually (add a temporary highlight effect)
    let highlightIcon;
    
    if (type === 'hotel') {
        highlightIcon = L.divIcon({
            className: 'hotel-marker-icon',
            iconSize: [60, 60],
            iconAnchor: [30, 60],
            html: `<div class="hotel-marker" style="transform: scale(1.5); animation: pulse 1s infinite;"><span>🏨</span></div>`
        });
    } else if (type === 'restaurant') {
        highlightIcon = L.divIcon({
            className: 'restaurant-marker-icon',
            iconSize: [60, 60],
            iconAnchor: [30, 60],
            html: `<div class="restaurant-marker" style="transform: scale(1.5); animation: pulse 1s infinite;"><span>🍽️</span></div>`
        });
    } else if (categoryIcons[type]) {
        highlightIcon = L.divIcon({
            className: `${type}-marker-icon`,
            iconSize: [60, 60],
            iconAnchor: [30, 60],
            html: `<div class="${type}-marker" style="transform: scale(1.5); animation: pulse 1s infinite;"><span>${categoryEmoji[type]}</span></div>`
        });
    }
    
    if (highlightIcon) {
        const highlightMarker = L.marker([lat, lng], { icon: highlightIcon }).addTo(map);
        
        // Remove highlight after a few seconds
        setTimeout(() => {
            map.removeLayer(highlightMarker);
        }, 3000);
    }
 }
 
 // Function to toggle map display between all, hotels only, or restaurants only
 function toggleMapDisplay(type) {
    // Update active button
    document.querySelectorAll('.filter-button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Clear all category layers first
    Object.values(currentCategoryLayers).forEach(layer => {
        if (map.hasLayer(layer)) {
            map.removeLayer(layer);
        }
    });
    
    // Toggle layers based on selection
    if (type === 'all') {
        map.addLayer(markersLayer);
        map.addLayer(hotelsLayer);
        map.addLayer(restaurantsLayer);
        
        // Re-add current selected category if any
        if (currentSelectedCategory && currentCategoryLayers[currentSelectedCategory]) {
            map.addLayer(currentCategoryLayers[currentSelectedCategory]);
        }
    } else if (type === 'hotels') {
        map.removeLayer(restaurantsLayer);
        map.addLayer(markersLayer);
        map.addLayer(hotelsLayer);
        
        // Hide all category layers
        Object.values(currentCategoryLayers).forEach(layer => {
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            }
        });
    } else if (type === 'restaurants') {
        map.removeLayer(hotelsLayer);
        map.addLayer(markersLayer);
        map.addLayer(restaurantsLayer);
        
        // Hide all category layers
        Object.values(currentCategoryLayers).forEach(layer => {
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            }
        });
    }
 }
 
 // Function to center map on current place
 function centerMapOnPlace() {
    if (currentPlace && currentPlace.location) {
        map.flyTo([currentPlace.location.lat, currentPlace.location.lng], 12, { 
            duration: 1.5,
            easeLinearity: 0.5
        });
    }
 }
 
 // Helper function to generate star ratings
 function generateStars(rating) {
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
    
    let starsHTML = '';
    
    // Full stars
    for (let i = 0; i < fullStars; i++) {
        starsHTML += '<span class="star full-star">★</span>';
    }
    
    // Half star
    if (hasHalfStar) {
        starsHTML += '<span class="star half-star">★</span>';
    }
    
    // Empty stars
    for (let i = 0; i < emptyStars; i++) {
        starsHTML += '<span class="star empty-star">☆</span>';
    }
    
    return starsHTML;
 }
 
 // Function to update main image in gallery
 function updateMainImage(imgSrc, thumbElement) {
    document.getElementById('mainPlaceImage').src = imgSrc;
    
    // Update active thumbnail
    document.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.classList.remove('active');
    });
    thumbElement.classList.add('active');
 }
 
 async function loadTouristPlaceDetails(placeName, stateName) {
    try {
        document.getElementById('stateDetails').innerHTML = `
            <div class="loading">
                <div class="loading-icon"></div>
                <p>Loading details for ${placeName}...</p>
            </div>
        `;
        
        // Clear any active category selection
        currentSelectedCategory = null;
        
        // Clear previous accommodation markers
        hotelsLayer.clearLayers();
        restaurantsLayer.clearLayers();
        
        // Clear all category layers
        Object.values(currentCategoryLayers).forEach(layer => {
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            }
        });
        
        // Fetch tourist place details from the backend
        const response = await fetch(`/api/tourist-place?name=${encodeURIComponent(placeName)}&state=${encodeURIComponent(stateName)}`);
        
        if (!response.ok) throw new Error('Failed to fetch tourist place details');
        
        const placeDetails = await response.json();
        currentPlace = placeDetails;
        
        // Initialize hotels and restaurants arrays if they don't exist
        if (!currentPlace.hotels) {
            currentPlace.hotels = [];
        }
        
        if (!currentPlace.restaurants) {
            currentPlace.restaurants = [];
        }
        // Inside loadTouristPlaceDetails function, after you've fetched placeDetails
// Add street view URL 
// Inside loadTouristPlaceDetails function, after you've fetched placeDetails
// Add street view URL 
if (placeDetails.location) {
    placeDetails.streetViewUrl = generateStreetViewUrl(
        placeDetails.name, 
        placeDetails.location.lat, 
        placeDetails.location.lng
    );
}
        // Focus map on tourist place location
        if (placeDetails.location) {
            // Add the main place marker
            const placeMarker = L.marker([placeDetails.location.lat, placeDetails.location.lng], {
                icon: touristPlaceIcon
            }).addTo(markersLayer);
            
            placeMarker.bindPopup(`
                <div class="popup-title">${placeDetails.name}</div>
                <div class="popup-info">
                    <strong>Location:</strong> ${stateName}<br>
                    ${placeDetails.entryFee ? `<strong>Entry Fee:</strong> ${placeDetails.entryFee}<br>` : ''}
                    ${placeDetails.timings ? `<strong>Timings:</strong> ${placeDetails.timings}` : ''}
                </div>
            `);
            
            // Add hotel markers from database
            if (placeDetails.hotels && placeDetails.hotels.length > 0) {
                placeDetails.hotels.forEach(hotel => {
                    if (hotel.location) {
                        const hotelMarker = L.marker([hotel.location.lat, hotel.location.lng], {
                            icon: hotelIcon
                        }).addTo(hotelsLayer);
                        
                        hotelMarker.bindPopup(`
                            <div class="popup-title">${hotel.name}</div>
                            <div class="popup-info">
                                <strong>Price Range:</strong> ${hotel.priceRange}<br>
                                <strong>Rating:</strong> ${hotel.rating.toFixed(1)} / 5<br>
                                <p>${hotel.description}</p>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${hotel.location.lat},${hotel.location.lng}&travelmode=driving" 
                                   target="_blank" 
                                   style="color: var(--primary); text-decoration: none; font-weight: 600; display: inline-block; margin-top: 10px;">
                                    🧭 Get Directions
                                </a>
                            </div>
                        `);
                    }
                });
            }
            
            // Add restaurant markers from database
            if (placeDetails.restaurants && placeDetails.restaurants.length > 0) {
                placeDetails.restaurants.forEach(restaurant => {
                    if (restaurant.location) {
                        const restaurantMarker = L.marker([restaurant.location.lat, restaurant.location.lng], {
                            icon: restaurantIcon
                        }).addTo(restaurantsLayer);
                        
                        restaurantMarker.bindPopup(`
                            <div class="popup-title">${restaurant.name}</div>
                            <div class="popup-info">
                                <strong>Cuisine:</strong> ${restaurant.cuisine}<br>
                                <strong>Price Range:</strong> ${restaurant.priceRange}<br>
                                <strong>Rating:</strong> ${restaurant.rating.toFixed(1)} / 5<br>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${restaurant.location.lat},${restaurant.location.lng}&travelmode=driving" 
                                   target="_blank" 
                                   style="color: var(--primary); text-decoration: none; font-weight: 600; display: inline-block; margin-top: 10px;">
                                    🧭 Get Directions
                                </a>
                            </div>
                        `);
                    }
                });
            }
            
            // If location data exists but useGeoapify flag is true or no hotels/restaurants from database,
            // load from Geoapify API
            if (placeDetails.location && 
                (placeDetails.useGeoapify === true || 
                 currentPlace.hotels.length === 0 || 
                 currentPlace.restaurants.length === 0)) {
                
                // Load nearby places from API
                await loadNearbyPlacesForTouristSpot(placeDetails.name, placeDetails.location.lat, placeDetails.location.lng);
            }
            
            // Fly to the place location
            map.flyTo([placeDetails.location.lat, placeDetails.location.lng], 12, { 
                duration: 1.5,
                easeLinearity: 0.5
            });
            
            // Open the place popup
            placeMarker.openPopup();
        }
        
        // Display the place details with real hotels and restaurants
        displayTouristPlaceDetails(currentPlace);
        
    } catch (error) {
        console.error("Error loading tourist place details:", error);
        document.getElementById('stateDetails').innerHTML = `
            <div class="error">
                <strong>Oops!</strong> Unable to load details for ${placeName}. Please try again.
            </div>
        `;
    }
 }
 
 // Make sure the loadNearbyPlacesForTouristSpot function handles cases where no hotels/restaurants exist
 async function loadNearbyPlacesForTouristSpot(placeName, lat, lng) {
    try {
        // Always load from API if there's a location
        const radius = 5000; // 5km
        
        // If there are no hotels from database, load from API
        if (currentPlace.hotels.length === 0) {
            const hotelsUrl = `https://api.geoapify.com/v2/places?categories=accommodation.hotel,accommodation.hostel&filter=circle:${lng},${lat},${radius}&limit=10&apiKey=${geoapifyKey}`;
            
            console.log("Fetching nearby hotels:", hotelsUrl);
            const hotelsResponse = await fetch(hotelsUrl);
            const hotelsData = await hotelsResponse.json();
            console.log("Hotels data:", hotelsData);
            
            if (hotelsData.features && hotelsData.features.length > 0) {
                // Convert API data to our hotel format
                hotelsData.features.forEach(hotel => {
                    const [hotelLng, hotelLat] = hotel.geometry.coordinates;
                    const name = hotel.properties.name || 'Hotel near ' + placeName;
                    const address = hotel.properties.formatted || 'Address not available';
                    
                    // Add to our currentPlace.hotels array
                    currentPlace.hotels.push({
                        name: name,
                        description: address,
                        priceRange: "Price information not available",
                        location: {
                            lat: hotelLat,
                            lng: hotelLng
                        },
                        rating: hotel.properties.rating || 4.0,
                        image: "https://images.unsplash.com/photo-1566073771259-6a8506099945?w=500"
                    });
                    
                    // Add hotel marker
                    const hotelMarker = L.marker([hotelLat, hotelLng], {
                        icon: hotelIcon
                    }).addTo(hotelsLayer);
                    
                    hotelMarker.bindPopup(`
                        <div class="popup-title">${name}</div>
                        <div class="popup-info">
                            <p>${address}</p>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${hotelLat},${hotelLng}" 
                               target="_blank" 
                               style="color: var(--primary); text-decoration: none; font-weight: 600; display: inline-block; margin-top: 10px;">
                                🧭 Get Directions
                            </a>
                        </div>
                    `);
                });
            }
        }
        
        // If there are no restaurants from database, load from API
        if (currentPlace.restaurants.length === 0) {
            const restaurantsUrl = `https://api.geoapify.com/v2/places?categories=catering.restaurant&filter=circle:${lng},${lat},${radius}&limit=10&apiKey=${geoapifyKey}`;
            
            console.log("Fetching nearby restaurants:", restaurantsUrl);
            const restaurantsResponse = await fetch(restaurantsUrl);
            const restaurantsData = await restaurantsResponse.json();
            console.log("Restaurants data:", restaurantsData);
            
            if (restaurantsData.features && restaurantsData.features.length > 0) {
                // Convert API data to our restaurant format
                restaurantsData.features.forEach(restaurant => {
                    const [restaurantLng, restaurantLat] = restaurant.geometry.coordinates;
                    const name = restaurant.properties.name || 'Restaurant near ' + placeName;
                    const address = restaurant.properties.formatted || 'Address not available';
                    
                    // Add to our currentPlace.restaurants array
                    currentPlace.restaurants.push({
                        name: name,
                        cuisine: restaurant.properties.cuisine || "Local cuisine",
                        priceRange: "Price information not available",
                        location: {
                            lat: restaurantLat,
                            lng: restaurantLng
                        },
                        rating: restaurant.properties.rating || 4.0,
                        image: "https://images.unsplash.com/photo-1514326640560-7d063ef2aed5?w=500"
                    });
                    
                    // Add restaurant marker
                    const restaurantMarker = L.marker([restaurantLat, restaurantLng], {
                        icon: restaurantIcon
                    }).addTo(restaurantsLayer);
                    
                    restaurantMarker.bindPopup(`
                        <div class="popup-title">${name}</div>
                        <div class="popup-info">
                            <p>${address}</p>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${restaurantLat},${restaurantLng}" 
                               target="_blank" 
                               style="color: var(--primary); text-decoration: none; font-weight: 600; display: inline-block; margin-top: 10px;">
                                🧭 Get Directions
                            </a>
                        </div>
                    `);
                });
            }
        }
    } catch (error) {
        console.error('Error loading nearby places for tourist spot:', error);
    }
 }
 
 // Function for correct Google Maps navigation
 function openGoogleMapsNavigation(lat, lng, name) {
    if (!lat || !lng) return;
    
    // Use proper Google Maps URL format with coordinates and travel mode
    const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
    window.open(url, '_blank');
 }
 
 // Initialize map when page loads
 document.addEventListener('DOMContentLoaded', function() {
    initMap();
    initSearch(); // Add this line
    
    // Add some interactive effects
    document.querySelectorAll('.btn').forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px) scale(1.05)';
        });
        
        btn.addEventListener('mouseleave', function() {
            if (!this.classList.contains('btn-active')) {
                this.style.transform = 'translateY(0) scale(1)';
            }
        });
    });
});
 
 // Keyboard navigation
 document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && selectedState) {
        document.getElementById('stateDetails').innerHTML = '';
        document.querySelectorAll('.state-card').forEach(card => {
            card.classList.remove('active');
        });
        selectedState = null;
        
        // Clear accommodation markers
        hotelsLayer.clearLayers();
        restaurantsLayer.clearLayers();
        
        // Clear all category layers
        Object.values(currentCategoryLayers).forEach(layer => {
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            }
        });
    }
 });
 
 // Add parallax effect to header on scroll
 window.addEventListener('scroll', function() {
    const scrolled = window.pageYOffset;
    const header = document.querySelector('.header');
    if (header) {
        header.style.transform = `translateY(${scrolled * 0.5}px)`;
    }
 });
 
 // Global variables for search
let allStates = [];
let allTouristPlaces = {};

// Function to load all states and places data for search
async function loadSearchData() {
    try {
        // Fetch all states for search
        const response = await fetch('/api/all-states');
        if (!response.ok) throw new Error('Failed to fetch all states');
        
        const states = await response.json();
        allStates = states;
        
        // Extract all tourist places from the states
        states.forEach(state => {
            if (state.touristPlaces && state.touristPlaces.length > 0) {
                state.touristPlaces.forEach(place => {
                    allTouristPlaces[place] = state.name;
                });
            }
        });
        
        console.log(`Loaded ${allStates.length} states and ${Object.keys(allTouristPlaces).length} tourist places for search`);
    } catch (error) {
        console.error('Error loading search data:', error);
    }
}

// Function to perform search
function performSearch() {
    const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
    const resultsContainer = document.getElementById('searchResults');
    
    if (searchTerm.length < 2) {
        resultsContainer.innerHTML = '';
        resultsContainer.classList.remove('active');
        return;
    }
    
    let results = [];
    
    // Search in states
    allStates.forEach(state => {
        if (state.name.toLowerCase().includes(searchTerm)) {
            results.push({
                type: 'state',
                name: state.name,
                subtitle: `${state.capital} - ${state.region.charAt(0).toUpperCase() + state.region.slice(1)} India`,
                data: state
            });
        }
    });
    
    // Search in tourist places
    Object.entries(allTouristPlaces).forEach(([placeName, stateName]) => {
        if (placeName.toLowerCase().includes(searchTerm)) {
            results.push({
                type: 'place',
                name: placeName,
                subtitle: `Tourist Place in ${stateName}`,
                stateName: stateName
            });
        }
    });
    
    // Display results
    if (results.length > 0) {
        let html = '';
        
        results.slice(0, 10).forEach(result => {
            // Highlight the matching part
            const highlightedName = result.name.replace(
                new RegExp(searchTerm, 'gi'),
                match => `<span class="search-highlight">${match}</span>`
            );
            
            html += `
                <div class="search-result-item" data-type="${result.type}" data-name="${result.name}" data-state="${result.stateName || ''}">
                    <div>
                        <div class="search-result-title">${highlightedName}</div>
                        <div class="search-result-subtitle">${result.subtitle}</div>
                    </div>
                    <div class="search-result-type ${result.type}">${result.type}</div>
                </div>
            `;
        });
        
        resultsContainer.innerHTML = html;
        resultsContainer.classList.add('active');
        
        // Add click event listeners to results
        document.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                const name = this.getAttribute('data-name');
                const stateName = this.getAttribute('data-state');
                
                if (type === 'state') {
                    // Find the state data
                    const stateData = allStates.find(state => state.name === name);
                    if (stateData) {
                        showStateDetails(stateData);
                        highlightStateCard(name);
                        
                        // Fly to state location
                        const coords = stateCoordinates[name];
                        if (coords) {
                            map.flyTo(coords, 8, { duration: 1.5 });
                        }
                    }
                } else if (type === 'place') {
                    // Load tourist place details
                    loadTouristPlaceDetails(name, stateName);
                }
                
                // Clear search
                document.getElementById('searchInput').value = '';
                resultsContainer.classList.remove('active');
            });
        });
    } else {
        resultsContainer.innerHTML = '<div class="no-results">No results found</div>';
        resultsContainer.classList.add('active');
    }
}

// Initialize search
function initSearch() {
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    
    // Load search data
    loadSearchData();
    
    // Add event listeners
    searchInput.addEventListener('input', performSearch);
    searchButton.addEventListener('click', performSearch);
    
    // Handle enter key
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        const searchContainer = document.querySelector('.search-wrapper');
        const searchResults = document.getElementById('searchResults');
        
        if (!searchContainer.contains(e.target)) {
            searchResults.classList.remove('active');
        }
    });
}

// Monument recognition code - FIXED to integrate with search
document.addEventListener('DOMContentLoaded', function() {
    const monumentImageInput = document.getElementById('monumentImageInput');
    const searchInput = document.getElementById('searchInput');
    const monumentResults = document.getElementById('monumentResults');
    const monumentPreview = document.querySelector('.monument-preview');
    const monumentInfo = document.querySelector('.monument-info');
    const viewMonumentDetails = document.getElementById('viewMonumentDetails');
    
    // Handle image selection with actual API call
    monumentImageInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            const file = e.target.files[0];
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                // Clear search input and results
                searchInput.value = '';
                document.getElementById('searchResults').classList.remove('active');
                
                // Show monument preview with loading message
                monumentPreview.innerHTML = `<img src="${e.target.result}" alt="Monument preview">`;
                monumentInfo.innerHTML = `<p>Analyzing monument image...</p>`;
                monumentResults.style.display = 'block';
                
                // Create form data for upload
                const formData = new FormData();
                formData.append('image', file);
                
                // Send to server with improved error handling
                fetch('/predict', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    console.log('Server response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Prediction result:', data);
                    
                    if (data && data.success) {
                        // Store original prediction
                        const originalPrediction = data.prediction;
                        
                        // Create normalized versions for better matching
                        const normalizedPrediction = normalizePlaceName(originalPrediction);
                        
                        monumentInfo.innerHTML = `
                            <h3>${originalPrediction}</h3>
                            <p>${data.place_info ? data.place_info.description : 'No detailed information available for this monument.'}</p>
                        `;
                        
                        // Setup view details button - FIXED to integrate with search and handle variations
                        viewMonumentDetails.onclick = () => {
                            if (data.place_info) {
                                // Try to find the best match from our tourist places
                                const bestMatch = findBestPlaceMatch(normalizedPrediction);
                                
                                if (bestMatch) {
                                    console.log(`Found best match: ${bestMatch.name} in ${bestMatch.state}`);
                                    
                                    // If direct match was found, load it directly
                                    loadTouristPlaceDetails(bestMatch.name, bestMatch.state);
                                    
                                    // Hide monument results
                                    monumentResults.style.display = 'none';
                                    
                                    // Scroll to top for better visibility
                                    window.scrollTo({ top: 0, behavior: 'smooth' });
                                } else {
                                    // Fallback to search using original prediction
                                    searchInput.value = originalPrediction;
                                    monumentResults.style.display = 'none';
                                    performSearch();
                                    window.scrollTo({ top: 0, behavior: 'smooth' });
                                }
                            }
                        };
                    } else {
                        monumentInfo.innerHTML = `<p>Could not identify the monument. Please try another image.</p>`;
                    }
                })
                .catch(error => {
                    console.error('Error in monument recognition:', error);
                    monumentInfo.innerHTML = `<p>Error analyzing image: ${error.message}</p>`;
                });
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Helper function to normalize place names for better matching
    function normalizePlaceName(name) {
        // Remove spaces, convert to lowercase, and remove special characters
        return name.toLowerCase()
                  .replace(/\s+/g, '')
                  .replace(/[^a-z0-9]/gi, '');
    }
    
    // Function to find the best match for a monument name
    function findBestPlaceMatch(normalizedName) {
        // First try direct match with normalized names
        for (const [placeName, stateName] of Object.entries(allTouristPlaces)) {
            const normalizedPlace = normalizePlaceName(placeName);
            
            // Check for exact match or if one contains the other
            if (normalizedPlace === normalizedName || 
                normalizedPlace.includes(normalizedName) || 
                normalizedName.includes(normalizedPlace)) {
                return { name: placeName, state: stateName };
            }
        }
        
        // If no direct match, try more flexible matching
        for (const [placeName, stateName] of Object.entries(allTouristPlaces)) {
            const normalizedPlace = normalizePlaceName(placeName);
            
            // Check for partial matches with at least 70% similarity
            if (isSubstantiallyMatch(normalizedPlace, normalizedName)) {
                return { name: placeName, state: stateName };
            }
        }
        
        return null; // No match found
    }
    
    // Function to check if two strings are substantially similar
    function isSubstantiallyMatch(str1, str2) {
        // If one is much longer than the other, probably not a match
        // If one is much longer than the other, probably not a match
        if (str1.length > str2.length * 2 || str2.length > str1.length * 2) {
            return false;
        }
        
        // Count matching characters
        let matchCount = 0;
        const shortStr = str1.length < str2.length ? str1 : str2;
        const longStr = str1.length < str2.length ? str2 : str1;
        
        for (let i = 0; i < shortStr.length; i++) {
            if (longStr.includes(shortStr[i])) {
                matchCount++;
            }
        }
        
        // Calculate similarity percentage
        const similarity = matchCount / shortStr.length;
        return similarity > 0.7; // At least 70% similar
    }
});
// Function to toggle street view fullscreen
function toggleStreetViewFullscreen() {
    const iframe = document.getElementById('streetViewFrame');
    if (iframe) {
        if (document.fullscreenElement) {
            document.exitFullscreen();
        } else {
            iframe.requestFullscreen().catch(err => {
                console.error(`Error attempting to enable fullscreen: ${err.message}`);
            });
        }
    }
}

// Function to open in Google Maps
function openInGoogleMaps(placeName, lat, lng) {
    if (lat && lng) {
        window.open(`https://www.google.com/maps/@${lat},${lng},3a,75y,90t/data=!3m7!1e1!3m5!1s!2e0!6shttps:%2F%2Fstreetviewpixels-pa.googleapis.com%2Fv1%2Fthumbnail!7i16384!8i8192`, '_blank');
    } else {
        window.open(`https://www.google.com/maps/search/${encodeURIComponent(placeName)}`, '_blank');
    }
}
// Function to hide street view loading screen
function hideStreetViewLoading() {
    const loadingElement = document.getElementById('streetViewLoading');
    if (loadingElement) {
        loadingElement.style.opacity = 0;
        setTimeout(() => {
            loadingElement.style.display = 'none';
        }, 500);
    }
}
// Function to hide street view loading screen
function hideStreetViewLoading() {
    const loadingElement = document.getElementById('streetViewLoading');
    if (loadingElement) {
        loadingElement.style.opacity = 0;
        setTimeout(() => {
            loadingElement.style.display = 'none';
        }, 500);
    }
}

// Function to toggle street view fullscreen
function toggleStreetViewFullscreen() {
    const iframe = document.getElementById('streetViewFrame');
    if (iframe) {
        if (document.fullscreenElement) {
            document.exitFullscreen();
        } else {
            iframe.requestFullscreen().catch(err => {
                console.error(`Error attempting to enable fullscreen: ${err.message}`);
            });
        }
    }
}

// Function to open in Google Maps
function openInGoogleMaps(placeName, lat, lng) {
    if (lat && lng) {
        window.open(`https://www.google.com/maps/@${lat},${lng},3a,75y,90t/data=!3m7!1e1!3m5!1s!2e0!6shttps:%2F%2Fstreetviewpixels-pa.googleapis.com%2Fv1%2Fthumbnail!7i16384!8i8192`, '_blank');
    } else {
        window.open(`https://www.google.com/maps/search/${encodeURIComponent(placeName)}`, '_blank');
    }
}
</script>
</html>
